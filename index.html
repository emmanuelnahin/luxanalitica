<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XLS Luxanalitica</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- Añadir pako para compresión -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <style>
        /* ESTILOS EXISTENTES MANTENIDOS - NO TOCAR */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            position: relative;
            transition: margin-left 0.3s ease;
        }
        
        body.sidebar-expanded {
            margin-left: 280px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        /* MODAL DE SEGURIDAD LEGAL - NUEVO */
        .security-modal {
            display: flex;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }
        
        .security-modal-content {
            background-color: white;
            padding: 40px;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            position: relative;
            max-height: 85vh;
            overflow-y: auto;
            border-left: 8px solid #1565c0;
        }
        
        .security-modal h2 {
            color: #0d47a1;
            margin-bottom: 20px;
            font-size: 2rem;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .security-modal h2 i {
            color: #1565c0;
        }
        
        .security-warning {
            background-color: #fff3e0;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #f57c00;
            margin: 20px 0;
        }
        
        .security-warning h3 {
            color: #f57c00;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .legal-terms {
            background-color: #f5f5f5;
            padding: 25px;
            border-radius: 10px;
            margin: 25px 0;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
        }
        
        .legal-terms h4 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }
        
        .legal-terms ul {
            margin-left: 20px;
            margin-bottom: 15px;
        }
        
        .legal-terms li {
            margin-bottom: 8px;
            line-height: 1.5;
        }
        
        .terms-checkbox {
            margin: 25px 0;
            padding: 15px;
            background-color: #e8f5e9;
            border-radius: 8px;
            border-left: 4px solid #4caf50;
        }
        
        .terms-checkbox label {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
            color: #333;
            cursor: pointer;
        }
        
        .terms-checkbox input[type="checkbox"] {
            width: 40px;
            height: 40px;
            cursor: pointer;
        }
        
        .modal-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }
        
        /* SIDEBAR MENU - NUEVO */
        .sidebar {
            position: fixed;
            left: -250px;
            top: 0;
            width: 280px;
            height: 100vh;
            background: linear-gradient(180deg, #0d47a1 0%, #1565c0 100%);
            color: white;
            z-index: 1000;
            transition: left 0.3s ease;
            box-shadow: 5px 0 25px rgba(0, 0, 0, 0.2);
            overflow-y: auto;
            padding-top: 20px;
        }
        
        .sidebar.expanded {
            left: 0;
        }
        
        .sidebar-toggle {
            position: fixed;
            left: 20px;
            top: 20px;
            background: #1565c0;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1001;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            font-size: 1.5rem;
        }
        
        .sidebar-toggle:hover {
            background: #0d47a1;
            transform: scale(1.1);
        }
        
        .sidebar-header {
            padding: 25px 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }
        
        .sidebar-header h3 {
            font-size: 1.4rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .sidebar-header p {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .menu-items {
            padding: 0 15px;
        }
        
        .menu-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 18px 20px;
            margin-bottom: 10px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            background: rgba(255, 255, 255, 0.05);
        }
        
        .menu-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }
        
        .menu-item.active {
            background: rgba(255, 255, 255, 0.15);
            border-left: 4px solid #ff9800;
            font-weight: 600;
        }
        
        .menu-item.active::after {
            content: '✓';
            position: absolute;
            right: 20px;
            color: #4caf50;
            font-weight: bold;
        }
        
        .menu-item i {
            font-size: 1.3rem;
            width: 30px;
            text-align: center;
        }
        
        .menu-item-text h4 {
            font-size: 1.1rem;
            margin-bottom: 5px;
        }
        
        .menu-item-text p {
            font-size: 0.85rem;
            opacity: 0.8;
            line-height: 1.4;
        }
        
        .coming-soon-badge {
            background: #ff9800;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .menu-section {
            margin: 25px 0 15px 20px;
            font-size: 0.9rem;
            opacity: 0.7;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .sidebar-footer {
            padding: 20px;
            margin-top: 40px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.8rem;
            opacity: 0.7;
            text-align: center;
        }
        
        /* SEÑALIZACIÓN DE SECCIONES EN CONSTRUCCIÓN */
        .construction-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }
        
        .construction-message {
            background: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            max-width: 500px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        
        /* ESTILOS ORIGINALES DEL HTML - MANTENIDOS SIN CAMBIOS */
        /* [Todos los estilos originales se mantienen aquí] */
        header {
            background: linear-gradient(135deg, #0d47a1, #1565c0);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .header-content {
            position: relative;
            z-index: 2;
        }
        
        h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            max-width: 900px;
            margin: 0 auto 20px;
        }
        
        .logo-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 20px;
            border-radius: 30px;
            font-weight: 600;
            font-size: 1.2rem;
            backdrop-filter: blur(5px);
        }
        
        .header-time {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .progress-container {
            background-color: #e3f2fd;
            padding: 15px 30px;
            border-bottom: 1px solid #bbdefb;
        }
        
        .progress-steps {
            display: flex;
            justify-content: space-between;
            max-width: 800px;
            margin: 0 auto;
            position: relative;
        }
        
        .progress-steps::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 3px;
            background-color: #bbdefb;
            z-index: 1;
        }
        
        .progress-bar {
            position: absolute;
            top: 20px;
            left: 0;
            height: 3px;
            background-color: #1565c0;
            z-index: 2;
            transition: width 0.5s ease;
        }
        
        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 3;
            position: relative;
        }
        
        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #bbdefb;
            color: #0d47a1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 8px;
            border: 3px solid #e3f2fd;
            transition: all 0.3s ease;
        }
        
        .step.active .step-circle {
            background-color: #1565c0;
            color: white;
            border-color: #1565c0;
            box-shadow: 0 0 0 5px rgba(21, 101, 192, 0.2);
        }
        
        .step.completed .step-circle {
            background-color: #0d47a1;
            color: white;
            border-color: #0d47a1;
        }
        
        .step-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: #555;
        }
        
        .step.active .step-label {
            color: #1565c0;
        }
        
        .main-content {
            padding: 30px;
        }
        
        .upload-section {
            background-color: #f9fafc;
            padding: 30px;
            border-radius: 12px;
            border: 2px dashed #1565c0;
            margin-bottom: 40px;
            text-align: center;
        }
        
        .file-input-container {
            padding: 40px 20px;
            border-radius: 10px;
            background-color: white;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            border: 2px solid #e3f2fd;
        }
        
        .file-input-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(21, 101, 192, 0.15);
        }
        
        .file-input-label {
            display: inline-block;
            background: linear-gradient(to right, #1565c0, #0d47a1);
            color: white;
            padding: 18px 40px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(21, 101, 192, 0.3);
        }
        
        .file-input-label:hover {
            background: linear-gradient(to right, #0d47a1, #08306b);
            transform: scale(1.05);
            box-shadow: 0 6px 18px rgba(21, 101, 192, 0.4);
        }
        
        .file-input {
            display: none;
        }
        
        .file-name {
            margin-top: 20px;
            font-size: 1.1rem;
            color: #1565c0;
            font-weight: 500;
        }
        
        /* Requirements acordeón mejorado */
        .requirements {
            background-color: #e3f2fd;
            border-radius: 10px;
            margin-top: 25px;
            border-left: 5px solid #1565c0;
            text-align: left;
            overflow: hidden;
        }
        
        .requirements-header {
            cursor: pointer;
            padding: 15px 20px;
            background: #1565c0;
            color: white;
            margin-bottom: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }
        
        .requirements-header:hover {
            background: #0d47a1;
        }
        
        .requirements-header h3 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .requirements-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .requirements-content.expanded {
            max-height: 500px;
            padding: 20px;
        }
        
        .requirements-content ul {
            margin-left: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 10px;
        }
        
        .requirements-content li {
            margin-bottom: 8px;
            padding: 5px 0;
        }
        
        .config-section {
            background-color: #f0f7ff;
            padding: 30px;
            border-radius: 12px;
            margin: 30px 0;
            border-left: 5px solid #1565c0;
            display: none;
        }
        
        .config-toggle-section {
            background: linear-gradient(to right, #ff9800, #f57c00);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .config-toggle-section h4 {
            margin: 0;
            font-size: 1.2rem;
        }
        
        .config-toggle-section p {
            margin: 5px 0 0 0;
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        #configWarning {
            margin-top: 15px;
            padding: 15px;
            background: rgba(255,255,255,0.2);
            border-radius: 5px;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }
        
        .config-group {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        }
        
        .config-group label {
            font-weight: 600;
            color: #0d47a1;
            margin-bottom: 15px;
            display: block;
            font-size: 1.1rem;
        }
        
        .config-group div {
            margin-top: 10px;
        }
        
        .config-group input[type="checkbox"] {
            margin-right: 8px;
        }
        
        .config-group input[type="number"] {
            width: 70px;
            padding: 5px;
            border: 1px solid #bbdefb;
            border-radius: 4px;
            margin-left: 8px;
        }
        
        .btn {
            display: inline-block;
            padding: 16px 32px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            text-align: center;
            margin: 10px;
            min-width: 200px;
        }
        
        .btn-primary {
            background: linear-gradient(to right, #1565c0, #0d47a1);
            color: white;
            box-shadow: 0 4px 12px rgba(21, 101, 192, 0.3);
        }
        
        .btn-primary:hover {
            background: linear-gradient(to right, #0d47a1, #08306b);
            transform: translateY(-3px);
            box-shadow: 0 6px 18px rgba(21, 101, 192, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(to right, #2e7d32, #1b5e20);
            color: white;
            box-shadow: 0 4px 12px rgba(46, 125, 50, 0.3);
        }
        
        .btn-success:hover {
            background: linear-gradient(to right, #1b5e20, #0d3c13);
            transform: translateY(-3px);
            box-shadow: 0 6px 18px rgba(46, 125, 50, 0.4);
        }
        
        .btn-warning {
            background: linear-gradient(to right, #f57c00, #e65100);
            color: white;
            box-shadow: 0 4px 12px rgba(245, 124, 0, 0.3);
        }
        
        .btn-warning:hover {
            background: linear-gradient(to right, #e65100, #bf360c);
            transform: translateY(-3px);
            box-shadow: 0 6px 18px rgba(245, 124, 0, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(to right, #78909c, #546e7a);
            color: white;
        }
        
        .btn-secondary:hover {
            background: linear-gradient(to right, #607d8b, #455a64);
            transform: translateY(-3px);
        }
        
        .dashboard {
            display: none;
            margin-top: 40px;
        }
        
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e3f2fd;
        }
        
        .dashboard-title {
            color: #0d47a1;
            font-size: 2rem;
        }
        
        .security-notice {
            background-color: #fff3e0;
            padding: 15px 20px;
            border-radius: 8px;
            border-left: 4px solid #f57c00;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .security-notice i {
            color: #f57c00;
            margin-right: 10px;
        }
        
        #autoClearTimer {
            font-weight: bold;
            color: #e65100;
            background: rgba(255,255,255,0.3);
            padding: 2px 8px;
            border-radius: 4px;
        }
        
        .security-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.2);
            padding: 5px 10px;
            border-radius: 20px;
        }
        
        .toggle-anonymize {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: 20px;
        }
        
        .toggle-anonymize label {
            font-weight: 600;
            color: #555;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #1565c0;
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border-top: 5px solid #1565c0;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .stat-card.warning {
            border-top-color: #f57c00;
        }
        
        .stat-card.danger {
            border-top-color: #d32f2f;
        }
        
        .stat-card.success {
            border-top-color: #2e7d32;
        }
        
        .stat-title {
            font-size: 1rem;
            color: #666;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #0d47a1;
        }
        
        .stat-value.warning {
            color: #f57c00;
        }
        
        .stat-value.danger {
            color: #d32f2f;
        }
        
        .stat-value.success {
            color: #2e7d32;
        }
        
        .stat-desc {
            font-size: 0.9rem;
            color: #78909c;
            margin-top: 5px;
        }
        
        .percentage {
            font-size: 0.85rem;
            color: #666;
            font-weight: 500;
            margin-left: 5px;
        }
        
        .percentage-badge {
            display: inline-block;
            background: #e3f2fd;
            color: #1565c0;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            margin-left: 8px;
            font-weight: 600;
        }
        
        .gender-display {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
        }
        
        .gender-bar {
            height: 8px;
            background: #1565c0;
            border-radius: 4px;
            margin-top: 2px;
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .chart-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .chart-title {
            color: #0d47a1;
            margin-bottom: 20px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        .advanced-viz-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .viz-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .viz-title {
            color: #0d47a1;
            margin-bottom: 20px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        #orgChart {
            width: 100%;
            height: 500px;
            overflow: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            background-color: #fafafa;
        }
        
        .node rect {
            fill: #1565c0;
            stroke: #0d47a1;
            stroke-width: 1.5px;
            rx: 5;
            ry: 5;
        }
        
        .node text {
            font: 12px sans-serif;
            fill: white;
            font-weight: 500;
        }
        
        .link {
            fill: none;
            stroke: #90a4ae;
            stroke-width: 2px;
        }
        
        #heatmapContainer {
            width: 100%;
            height: 500px;
            overflow: auto;
        }
        
        .heatmap-cell {
            stroke: #fff;
            stroke-width: 1px;
        }
        
        .heatmap-label {
            font-size: 10px;
            text-anchor: end;
        }
        
        .data-sections {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .data-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e3f2fd;
        }
        
        .section-title {
            color: #0d47a1;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
        }
        
        th, td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid #e3f2fd;
        }
        
        th {
            background-color: #1565c0;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        tr:nth-child(even) {
            background-color: #f9fafc;
        }
        
        tr:hover {
            background-color: #f0f7ff;
        }
        
        .error-row {
            background-color: #ffebee !important;
            border-left: 4px solid #d32f2f;
        }
        
        .warning-row {
            background-color: #fff3e0 !important;
            border-left: 4px solid #f57c00;
        }
        
        .edit-cell {
            cursor: pointer;
            position: relative;
        }
        
        .edit-cell:hover {
            background-color: #e1f5fe !important;
        }
        
        .edit-icon {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            color: #1565c0;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .edit-cell:hover .edit-icon {
            opacity: 1;
        }
        
        .download-section {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            padding: 30px;
            border-radius: 12px;
            margin-top: 40px;
        }
        
        .export-options {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        }
        
        .export-options h3 {
            color: #0d47a1;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .option-group {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 15px;
        }
        
        .option-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .option-item label {
            font-weight: 500;
            color: #555;
        }
        
        .download-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }
        
        .download-card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            border-top: 5px solid #1565c0;
        }
        
        .download-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.15);
        }
        
        .download-icon {
            font-size: 3.5rem;
            margin-bottom: 20px;
            color: #1565c0;
        }
        
        .download-title {
            color: #0d47a1;
            font-size: 1.5rem;
            margin-bottom: 15px;
        }
        
        .download-desc {
            color: #666;
            margin-bottom: 25px;
            line-height: 1.5;
        }
        
        .footer {
            text-align: center;
            margin-top: 40px;
            padding: 25px;
            color: #546e7a;
            font-size: 0.95rem;
            border-top: 1px solid #e3f2fd;
            background-color: #f9fafc;
            border-radius: 0 0 15px 15px;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 60px 40px;
        }
        
        .brain-container {
            position: relative;
            width: 120px;
            height: 120px;
            margin: 0 auto 30px;
        }
        
        .brain-icon {
            font-size: 80px;
            color: #1565c0;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2;
            animation: brainPulse 2s infinite;
        }
        
        .brain-circle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100px;
            height: 100px;
            border: 8px solid #e3f2fd;
            border-top: 8px solid #1565c0;
            border-radius: 50%;
            animation: spin 1.5s linear infinite;
            z-index: 1;
        }
        
        .loading-time {
            font-size: 1.2rem;
            margin: 15px 0;
            color: #0d47a1;
            font-weight: 600;
        }
        
        .loading-estimate {
            color: #666;
            font-size: 0.95rem;
            margin-top: 10px;
            background: #f0f7ff;
            padding: 10px;
            border-radius: 8px;
            display: inline-block;
        }
        
        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
        
        @keyframes brainPulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            50% { transform: translate(-50%, -50%) scale(1.1); opacity: 0.8; }
        }
        
        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .badge-success {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        
        .badge-warning {
            background-color: #fff3e0;
            color: #ef6c00;
        }
        
        .badge-danger {
            background-color: #ffebee;
            color: #c62828;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 25px;
            border-radius: 12px;
            width: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            position: relative;
        }
        
        .close-modal {
            position: absolute;
            right: 20px;
            top: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #777;
        }
        
        .close-modal:hover {
            color: #000;
        }
        
        .modal-title {
            color: #0d47a1;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }
        
        .modal-body {
            margin: 20px 0;
        }
        
        .modal-footer {
            text-align: right;
            margin-top: 25px;
        }
        
        /* Nuevos estilos para progreso */
        .progress-modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
        }
        
        .progress-modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 30px;
            border-radius: 12px;
            width: 500px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        .progress-title {
            color: #0d47a1;
            margin-bottom: 20px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .progress-bar-container {
            width: 100%;
            height: 20px;
            background-color: #e3f2fd;
            border-radius: 10px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(to right, #1565c0, #0d47a1);
            border-radius: 10px;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .progress-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            color: #666;
        }
        
        .progress-message {
            margin-top: 15px;
            font-size: 0.9rem;
            color: #546e7a;
            text-align: center;
        }
        
        /* Nuevos estilos para mejoras de visualización */
        .org-chart-container {
            max-height: 600px;
            overflow-y: auto;
            overflow-x: auto;
        }
        
        .heatmap-container {
            max-height: 600px;
            overflow-y: auto;
            overflow-x: auto;
        }
        
        .evaluation-stats {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #2e7d32;
        }
        
        .evaluation-stats h4 {
            color: #1b5e20;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .stats-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .stats-label {
            font-weight: 600;
            color: #555;
        }
        
        .stats-value {
            font-weight: 700;
            color: #0d47a1;
        }
        
        .processing-time {
            background-color: #e8f5e9;
            padding: 12px 20px;
            border-radius: 8px;
            border-left: 4px solid #2e7d32;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .processing-time i {
            color: #2e7d32;
            font-size: 1.2rem;
        }
        
        .processing-time strong {
            color: #1b5e20;
        }
        
        /* NUEVOS ESTILOS PARA TABS/ACORDEONES */
        .tabs-container {
            background: white;
            border-radius: 12px;
            padding: 0;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }
        
        .tabs-header {
            display: flex;
            background: #f9fafc;
            border-bottom: 2px solid #e3f2fd;
            padding: 0;
        }
        
        .tab {
            padding: 18px 30px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1.1rem;
            color: #546e7a;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            text-align: center;
            justify-content: center;
        }
        
        .tab:hover {
            color: #1565c0;
            background-color: rgba(21, 101, 192, 0.05);
        }
        
        .tab.active {
            color: #1565c0;
            border-bottom-color: #1565c0;
            background-color: white;
        }
        
        .tab-content {
            display: none;
            padding: 25px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Estilos para tabla de duplicados */
        .duplicate-type-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
        }
        
        .duplicate-type-CRÍTICO {
            background-color: #ffebee;
            color: #d32f2f;
            border: 1px solid #ffcdd2;
        }
        
        .duplicate-type-IMPORTANTE {
            background-color: #fff3e0;
            color: #f57c00;
            border: 1px solid #ffe0b2;
        }
        
        .btn-investigar {
            background: linear-gradient(to right, #1565c0, #0d47a1);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-right: 5px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn-investigar:hover {
            background: linear-gradient(to right, #0d47a1, #08306b);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(21, 101, 192, 0.3);
        }
        
        .btn-consolidar {
            background: linear-gradient(to right, #2e7d32, #1b5e20);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn-consolidar:hover {
            background: linear-gradient(to right, #1b5e20, #0d3c13);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(46, 125, 50, 0.3);
        }
        
        /* NUEVOS ESTILOS PARA EL BOTÓN FLOTANTE DE CONTACTO */
        .contact-floating-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #1565c0, #0d47a1);
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 998;
            box-shadow: 0 5px 15px rgba(21, 101, 192, 0.3);
            transition: all 0.3s ease;
            font-size: 1.5rem;
        }
        
        .contact-floating-btn:hover {
            background: linear-gradient(135deg, #0d47a1, #08306b);
            transform: scale(1.1);
            box-shadow: 0 8px 20px rgba(21, 101, 192, 0.4);
        }
        
        .contact-panel {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 350px;
            max-height: 500px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 999;
            overflow: hidden;
            display: none;
            border: 1px solid #e3f2fd;
        }
        
        .contact-panel.expanded {
            display: block;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .contact-header {
            background: linear-gradient(135deg, #1565c0, #0d47a1);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .contact-header h3 {
            margin: 0;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .contact-body {
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .contact-body p {
            margin-bottom: 15px;
            line-height: 1.6;
            color: #333;
        }
        
        .contact-body strong {
            color: #0d47a1;
        }
        
        .contact-email {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #2e7d32;
            text-align: center;
        }
        
        .contact-email a {
            color: #1565c0;
            font-weight: 600;
            text-decoration: none;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .contact-email a:hover {
            color: #0d47a1;
            text-decoration: underline;
        }
        
        .contact-footer {
            padding: 15px;
            text-align: center;
            border-top: 1px solid #e3f2fd;
            background: #f9fafc;
            font-size: 0.9rem;
            color: #546e7a;
        }
        
        .close-contact {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-contact:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        @media (max-width: 768px) {
            body.sidebar-expanded {
                margin-left: 0;
            }
            
            .sidebar {
                width: 100%;
                left: -100%;
            }
            
            .sidebar.expanded {
                left: 0;
            }
            
            .sidebar-toggle {
                left: 10px;
                top: 10px;
                width: 40px;
                height: 40px;
                font-size: 1.2rem;
            }
            
            .charts-container, .data-sections, .advanced-viz-container {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .btn {
                min-width: 150px;
                padding: 14px 20px;
            }
            
            .logo-badge {
                position: relative;
                top: 0;
                right: 0;
                margin-top: 15px;
                display: inline-block;
            }
            
            .header-time {
                position: relative;
                top: 0;
                left: 0;
                margin: 10px auto;
                display: block;
                width: fit-content;
            }
            
            .modal-content {
                width: 90%;
                margin: 20% auto;
            }
            
            .progress-modal-content {
                width: 90%;
                margin: 30% auto;
            }
            
            .progress-steps {
                flex-direction: column;
                gap: 20px;
                align-items: flex-start;
            }
            
            .progress-steps::before, .progress-bar {
                display: none;
            }
            
            .step {
                flex-direction: row;
                gap: 15px;
            }
            
            .security-notice {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .toggle-anonymize {
                margin-left: 0;
                margin-top: 10px;
            }
            
            .requirements-content ul {
                grid-template-columns: 1fr;
            }
            
            .advanced-viz-container {
                grid-template-columns: 1fr;
            }
            
            .org-chart-container, .heatmap-container {
                max-height: 400px;
            }
            
            /* Ajustes para tabs en móviles */
            .tabs-header {
                flex-direction: column;
            }
            
            .tab {
                padding: 15px;
                justify-content: flex-start;
                border-bottom: 1px solid #e3f2fd;
                border-right: none;
            }
            
            .tab.active {
                border-right: 3px solid #1565c0;
                border-bottom: 1px solid #e3f2fd;
            }
            
            /* Ajustes para el panel de contacto en móviles */
            .contact-panel {
                width: calc(100% - 40px);
                right: 20px;
                left: 20px;
            }
            
            .contact-floating-btn {
                width: 50px;
                height: 50px;
                font-size: 1.3rem;
            }
        }
        
        .chartjs-datalabels {
            font-weight: 600;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        
        /* Estilo para botones de sugerencia */
        .btn-suggestion {
            padding: 5px 10px;
            font-size: 0.8rem;
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-suggestion:hover {
            background: #388e3c;
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <!-- MODAL DE SEGURIDAD LEGAL (siempre aparece al inicio) -->
    <div class="security-modal" id="securityModal">
        <div class="security-modal-content">
            <h2><i class="fas fa-shield-alt"></i> 🔒 Aviso de Privacidad y Seguridad Financiera</h2>
            
            <div class="security-warning">
                <h3><i class="fas fa-exclamation-triangle"></i> Información Importante</h3>
                <p>Esta herramienta procesa información sensible (datos personales, contables o financieros) <strong>exclusivamente en su navegador</strong>.</p>
                
                <ul>
                    <li><strong>Cero Transferencia:</strong> Sus archivos Excel no se suben a ningún servidor ni nube. Nadie, excepto usted, tiene acceso a la información.</li>
                    <li><strong>Responsabilidad:</strong> Al ser un proceso local, usted mantiene el control total y la responsabilidad legal sobre la protección de los datos procesados.</li>
                </ul>
            </div>
            
            <div class="terms-checkbox">
                <label>
                    <input type="checkbox" id="termsCheckbox">
                    <span>Declaro que tengo derecho a procesar estos datos, acepto los Términos de Servicio y entiendo que el uso de esta herramienta es bajo mi propia responsabilidad.</span>
                </label>
            </div>
            
            <div class="legal-terms" id="legalTerms">
                <h4>TÉRMINOS Y CONDICIONES - HERRAMIENTA DE PROCESAMIENTO LOCAL</h4>
                
                <p><strong>1. Naturaleza del Servicio y Ausencia de Intermediación de Datos</strong><br>
                El usuario reconoce que esta plataforma es una herramienta de software de ejecución local ("Client-Side").</p>
                
                <ul>
                    <li><strong>No somos Encargados del Tratamiento:</strong> El propietario de la web no recolecta, almacena, ni visualiza ningún dato personal, financiero o contable contenido en los archivos Excel del usuario.</li>
                    <li><strong>Cumplimiento Normativo:</strong> Dado que los datos nunca salen del dispositivo del usuario, el uso de esta herramienta no constituye una transferencia internacional de datos ni una cesión a terceros bajo las leyes de protección de datos vigentes.</li>
                </ul>
                
                <p><strong>2. Responsabilidad sobre Datos Personales y Financieros</strong><br>
                El usuario es el único "Responsable del Tratamiento" de los datos que carga.</p>
                
                <ul>
                    <li>El usuario garantiza que los datos personales (nombres, identificaciones, correos) y financieros (nóminas, balances, cuentas bancarias) son procesados legalmente y cuenta con el consentimiento de los titulares si fuera necesario.</li>
                    <li>El propietario de la web se exime de cualquier responsabilidad ante sanciones, multas o demandas derivadas de la manipulación indebida de datos sensibles por parte del usuario.</li>
                </ul>
                
                <p><strong>3. Exención de Responsabilidad en Cálculos Contables</strong><br>
                Aunque nos esforzamos por la precisión técnica, el software puede contener errores.</p>
                
                <ul>
                    <li><strong>Verificación Obligatoria:</strong> Esta herramienta no sustituye el criterio de un contador o auditor profesional. El usuario se compromete a verificar manualmente la exactitud de cualquier cálculo, suma, o conversión antes de presentar dicha información ante autoridades tributarias, bancos o terceros.</li>
                    <li>El desarrollador no se hace responsable por errores en declaraciones de impuestos, nóminas incorrectas o desajustes contables causados por el uso de la herramienta.</li>
                </ul>
                
                <p><strong>4. Seguridad del Entorno Local</strong><br>
                La confidencialidad de los datos depende íntegramente de la seguridad del dispositivo del usuario. Recomendamos no utilizar esta herramienta en ordenadores públicos (cibercafés, bibliotecas) si se procesan datos sensibles, ya que el navegador del usuario podría tener malware o extensiones que capturen información localmente, situación ajena a nuestro control.</p>
                
                <p><strong>5. Renuncia de Garantías y Limitación de Daños</strong><br>
                El servicio se entrega "TAL CUAL" (AS IS). En la máxima medida permitida por la ley, el propietario de la web no será responsable por daños directos o indirectos, lucro cesante o pérdida de información confidencial. El usuario asume todo el riesgo derivado del uso y rendimiento de la herramienta.</p>
            </div>
            
            <div class="modal-actions">
                <a href="#" id="viewLegalLink" style="color: #1565c0; text-decoration: none; font-size: 0.9rem;">
                    <i class="fas fa-file-contract"></i> Ver Términos Legales y Exención de Responsabilidad
                </a>
                <button id="accessToolBtn" class="btn btn-primary" disabled>
                    <i class="fas fa-door-open"></i> ACCEDER A LA HERRAMIENTA
                </button>
            </div>
        </div>
    </div>

    <!-- BOTÓN FLOTANTE Y PANEL DE CONTACTO -->
    <div class="contact-floating-btn" id="contactFloatingBtn">
        <i class="fas fa-comment-alt"></i>
    </div>
    
    <div class="contact-panel" id="contactPanel">
        <div class="contact-header">
            <h3><i class="fas fa-users"></i> ¿Quiénes Somos?</h3>
            <button class="close-contact" id="closeContactBtn">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="contact-body">
            <p><strong>Somos un grupo de ingenieros y estadistas que nos unimos junto a las IA para crear esta herramienta sin fines de lucro y abierta para el mundo.</strong></p>
            
            <p>Luxanalitica actúa como tu filtro de seguridad definitivo. Con solo cargar tu Excel, detectamos inconsistencias y anomalías matemáticas, generando reportes visuales al instante.</p>
            
            <p>Deja que tus sistemas gestionen el negocio y permítenos asegurar la calidad de tus datos. Olvídate del tedioso cruce manual de lógicas. Somos la intersección entre la precisión matemática y la realidad operativa.</p>
            
            <p>Transforma el riesgo en certeza estratégica, potenciando la herramienta que ya dominas: Excel.</p>
            
            <div class="contact-email">
                <a href="mailto:luxanalitica@gmail.com">
                    <i class="fas fa-envelope"></i> luxanalitica@gmail.com
                </a>
                <p style="margin-top: 10px; font-size: 0.9rem; color: #666;">
                    Envíanos tus sugerencias, desarrollos o mejoras que quieras que incorporemos
                </p>
            </div>
        </div>
        <div class="contact-footer">
            <i class="fas fa-heart" style="color: #e91e63;"></i> Herramienta creada con pasión por la analítica
        </div>
    </div>

    <!-- SIDEBAR MENU -->
    <div class="sidebar-toggle" id="sidebarToggle">
        <i class="fas fa-bars"></i>
    </div>
    
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3><i class="fas fa-rocket"></i> Luxanalitica Suite</h3>
            <p>HR Analytics Platform</p>
        </div>
        
        <div class="menu-section">MÓDULOS PRINCIPALES</div>
        <div class="menu-items">
            <div class="menu-item active" data-section="centro-datos">
                <i class="fas fa-database"></i>
                <div class="menu-item-text">
                    <h4>📂 Centro de Datos</h4>
                    <p>Donde todo comienza. Limpieza y validación de datos.</p>
                </div>
            </div>
            
            <div class="menu-item" data-section="analytics">
                <i class="fas fa-chart-bar"></i>
                <div class="menu-item-text">
                    <h4>📊 Tableros de Analytics <span class="coming-soon-badge">Próximamente</span></h4>
                    <p>Análisis descriptivo: demografía, compensaciones y rotación.</p>
                </div>
            </div>
            
            <div class="menu-item" data-section="kpis">
                <i class="fas fa-bullseye"></i>
                <div class="menu-item-text">
                    <h4>🎯 Planificador de KPIs y Bonos <span class="coming-soon-badge">Próximamente</span></h4>
                    <p>Configuración de reglas y simulador de pagos por desempeño.</p>
                </div>
            </div>
            
            <div class="menu-item" data-section="estructura">
                <i class="fas fa-sitemap"></i>
                <div class="menu-item-text">
                    <h4>🕸️ Estructura Organizacional <span class="coming-soon-badge">Próximamente</span></h4>
                    <p>Organigramas interactivos y análisis de tramos de control.</p>
                </div>
            </div>
        </div>
        
        <div class="menu-section">HERRAMIENTAS</div>
        <div class="menu-items">
            <div class="menu-item" data-section="evaluacion">
                <i class="fas fa-360-degrees"></i>
                <div class="menu-item-text">
                    <h4>🔄 Evaluación 360°</h4>
                    <p>Generación de relaciones ascendentes y pares (actual).</p>
                </div>
            </div>
        </div>
        
        <div class="sidebar-footer">
            <p>Versión 2.0 | Procesamiento 100% local</p>
            <p><i class="fas fa-lock"></i> Sus datos nunca salen de su dispositivo</p>
        </div>
    </div>

    <!-- OVERLAY PARA SECCIONES EN CONSTRUCCIÓN -->
    <div class="construction-overlay" id="constructionOverlay">
        <div class="construction-message">
            <i class="fas fa-tools" style="font-size: 4rem; color: #1565c0; margin-bottom: 20px;"></i>
            <h2 style="color: #0d47a1; margin-bottom: 15px;">🚧 Sección en Construcción</h2>
            <p style="margin-bottom: 20px; color: #666; line-height: 1.6;">
                Esta funcionalidad estará disponible muy pronto. Estamos trabajando en nuevas herramientas avanzadas para análisis de People Analytics.
            </p>
            <p style="font-style: italic; color: #888; margin-bottom: 25px;">
                "Mientras tanto, puedes utilizar todas las funciones del <strong>Centro de Datos</strong> y la <strong>Evaluación 360°</strong> que ya están operativas."
            </p>
            <button id="closeConstructionBtn" class="btn btn-primary">
                <i class="fas fa-arrow-left"></i> Volver al Centro de Datos
            </button>
        </div>
    </div>

    <!-- CONTENIDO PRINCIPAL ORIGINAL (NO MODIFICADO) -->
    <div class="container">
        <header>
            <div class="header-time">
                <i class="fas fa-clock"></i>
                <span id="currentDateTime">Cargando fecha y hora...</span>
            </div>
            <div class="header-content">
                <h1><i class="fas fa-chart-network"></i> XLS Luxanalitica - HR Analytics Suite</h1>
                <p class="subtitle">Herramienta avanzada para análisis de población, estructura organizacional y preparación de evaluaciones 360°</p>
                <div class="logo-badge">
                    <i class="fas fa-rocket"></i> PEOPLE ANALYTICS ENGINE
                </div>
            </div>
        </header>
        
        <div class="progress-container">
            <div class="progress-steps">
                <div class="step active" id="step1">
                    <div class="step-circle">1</div>
                    <div class="step-label">Cargar Datos</div>
                </div>
                <div class="step" id="step2">
                    <div class="step-circle">2</div>
                    <div class="step-label">Configurar</div>
                </div>
                <div class="step" id="step3">
                    <div class="step-circle">3</div>
                    <div class="step-label">Analizar</div>
                </div>
                <div class="step" id="step4">
                    <div class="step-circle">4</div>
                    <div class="step-label">Exportar</div>
                </div>
                <div class="progress-bar" id="progressBar"></div>
            </div>
        </div>
        
        <div class="main-content">
            <!-- SECCIÓN DE CENTRO DE DATOS (activada por defecto) -->
            <div class="upload-section" id="uploadSection">
                <h2 style="color: #0d47a1; margin-bottom: 25px; font-size: 1.8rem;">
                    <i class="fas fa-database"></i> Centro de Datos: Cargar Archivo de Población
                </h2>
                <p style="color: #546e7a; max-width: 800px; margin: 0 auto 25px; font-size: 1.1rem;">
                    Esta es la base de todo. Comienza subiendo tu archivo Excel para limpieza, validación y preparación de datos.
                </p>
                
                <div class="file-input-container">
                    <label for="fileInput" class="file-input-label">
                        <i class="fas fa-file-excel"></i> Seleccionar Archivo Excel de Población
                    </label>
                    <input type="file" id="fileInput" class="file-input" accept=".xlsx, .xls, .csv">
                    <p class="file-name" id="fileName">No se ha seleccionado ningún archivo</p>
                </div>
                
                <div class="requirements">
                    <div class="requirements-header" id="requirementsHeader">
                        <h3><i class="fas fa-info-circle"></i> Estructura esperada del archivo (click para expandir)</h3>
                        <i class="fas fa-chevron-down" id="requirementsChevron"></i>
                    </div>
                    <div class="requirements-content" id="requirementsContent">
                        <ul>
                            <li><strong>Columna A:</strong> identifier (Evaluado)</li>
                            <li><strong>Columna B:</strong> rut</li>
                            <li><strong>Columna C:</strong> nss</li>
                            <li><strong>Columna D:</strong> curp</li>
                            <li><strong>Columna E:</strong> civil_status</li>
                            <li><strong>Columna F:</strong> username</li>
                            <li><strong>Columna G:</strong> area</li>
                            <li><strong>Columna H:</strong> area_name</li>
                            <li><strong>Columna I:</strong> email</li>
                            <li><strong>Columna J:</strong> personal_email</li>
                            <li><strong>Columna K:</strong> firstname</li>
                            <li><strong>Columna L:</strong> middlename</li>
                            <li><strong>Columna M:</strong> lastname</li>
                            <li><strong>Columna N:</strong> mothername</li>
                            <li><strong>Columna O:</strong> display_name</li>
                            <li><strong>Columna P:</strong> gender</li>
                            <li><strong>Columna Q:</strong> birthdate</li>
                            <li><strong>Columna R:</strong> joiningdate</li>
                            <li><strong>Columna S:</strong> subdomain</li>
                            <li><strong>Columna T:</strong> position</li>
                            <li><strong>Columna U:</strong> position_name</li>
                            <li><strong>Columna V:</strong> description_position</li>
                            <li><strong>Columna W:</strong> manager_identifier (Jefe directo)</li>
                            <li>+ Otras columnas opcionales</li>
                        </ul>
                    </div>
                </div>
                
                <div style="margin-top: 35px;">
                    <button id="uploadBtn" class="btn btn-primary" disabled>
                        <i class="fas fa-arrow-right"></i> Continuar a Configuración
                    </button>
                    <button id="resetBtn" class="btn btn-secondary">
                        <i class="fas fa-redo"></i> Reiniciar
                    </button>
                </div>
            </div>
            
            <!-- SECCIÓN DE CONFIGURACIÓN -->
            <div class="config-section" id="configSection">
                <h2 style="color: #0d47a1; margin-bottom: 25px; font-size: 1.8rem;">
                    <i class="fas fa-cogs"></i> Paso 2: Configurar Análisis 360°
                </h2>
                
                <div class="config-toggle-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                        <div style="text-align: left;">
                            <h4 style="margin: 0; font-size: 1.2rem;"><i class="fas fa-sliders-h"></i> Configuración Avanzada</h4>
                            <p style="margin: 5px 0 0 0; font-size: 0.9rem; opacity: 0.9;">
                                <span id="configStatusText" style="font-weight: bold; color: #f44336;">DESACTIVADA</span> - Modo simple: se generarán todas las relaciones posibles
                            </p>
                        </div>
                        <label class="switch" style="transform: scale(1.3);">
                            <input type="checkbox" id="advancedConfigToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div id="configWarning">
                        <div id="configWarningInactive">
                            <i class="fas fa-info-circle"></i> 
                            <strong>Modo Simple Activado</strong><br>
                            Se generarán TODAS las relaciones posibles:<br>
                            • Ascendentes: Todas las relaciones manager → empleado<br>
                            • Pares: Todas las combinaciones entre empleados con el MISMO JEFE (excluyendo al jefe)<br>
                            • Sin límites de cantidad<br>
                            • Sin filtros por área<br>
                            • Máxima cobertura posible (100% de relaciones existentes)
                        </div>
                        <div id="configWarningActive" style="display: none;">
                            <i class="fas fa-cog"></i> 
                            <strong>Configuración Personalizada Activada</strong><br>
                            Las relaciones se generarán según los criterios configurados a continuación.
                        </div>
                    </div>
                </div>
                
                <div id="configOptions" style="opacity: 0.6; pointer-events: none;">
                    <div class="config-grid">
                        <div class="config-group">
                            <label><i class="fas fa-user-friends"></i> <strong>Criterio para Relaciones de "Pares":</strong></label>
                            <div>
                                <label><input type="checkbox" id="criteriaSameArea" disabled> Misma Área/Departamento</label><br>
                                <label><input type="checkbox" id="criteriaSameManager" checked> Mismo Jefe Directo</label><br>
                                <label><input type="checkbox" id="criteriaExcludeManager" checked> Excluir al Jefe de la lista de Pares</label><br>
                                <label>Máximo de pares por persona: <input type="number" id="maxParesPerPerson" value="1000" min="1" max="1000" disabled></label>
                            </div>
                        </div>
                        
                        <div class="config-group">
                            <label><i class="fas fa-chart-line"></i> <strong>Mínimos Recomendados por Evaluado:</strong></label>
                            <div>
                                <label>Ascendentes (Jefe): <input type="number" id="minAscendentes" value="1" min="0" max="3"></label><br>
                                <label>Pares: <input type="number" id="minPares" value="0" min="0" max="1000" disabled></label><br>
                                <label>Subordinados: <input type="number" id="minSubordinados" value="0" min="0" max="10"></label><br>
                                <label>Total evaluadores: <input type="number" id="minTotalEvaluadores" value="3" min="0" max="30"></label>
                            </div>
                        </div>
                        
                        <div class="config-group">
                            <label><i class="fas fa-balance-scale"></i> <strong>Límites de Carga y Validación:</strong></label>
                            <div>
                                <label>Máx. evaluaciones por persona: <input type="number" id="maxCarga" value="50" min="1" max="100"></label><br>
                                <label>% Mín. cobertura: <input type="number" id="minCobertura" value="90" min="1" max="100"> %</label><br>
                                <label><input type="checkbox" id="detectConflict" checked> Detectar conflictos de interés</label><br>
                                <label><input type="checkbox" id="autoBalance" checked> Intentar balance automático</label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 30px;">
                    <button id="applyConfigBtn" class="btn btn-primary">
                        <i class="fas fa-play-circle"></i> Aplicar Configuración y Analizar
                    </button>
                    <button id="backToUploadBtn" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Volver a Carga
                    </button>
                </div>
            </div>
            
            <!-- LOADING -->
            <div class="loading" id="loading">
                <div class="brain-container">
                    <i class="fas fa-brain brain-icon"></i>
                    <div class="brain-circle"></div>
                </div>
                <h3>Analizando datos de población...</h3>
                <p class="loading-time">Tiempo transcurrido: <span id="loadingSeconds">0.000</span> segundos</p>
                <p class="loading-estimate" id="loadingEstimate">
                    <i class="fas fa-chart-line"></i> Estimación: 1 segundo por cada 1,000 líneas
                </p>
            </div>
            
            <!-- DASHBOARD -->
            <div class="dashboard" id="dashboard">
                <div class="dashboard-header">
                    <h2 class="dashboard-title">
                        <i class="fas fa-tachometer-alt"></i> Dashboard de Análisis de Población
                    </h2>
                    <div id="analysisDate" style="color: #546e7a; font-weight: 500;"></div>
                </div>
                
                <!-- Tiempo de procesamiento -->
                <div class="processing-time" id="processingTime">
                    <i class="fas fa-stopwatch"></i>
                    <div>
                        <strong>Tiempo de procesamiento:</strong> 
                        <span id="finalProcessingTime">0.000</span> segundos para analizar 
                        <span id="totalProcessedEmployees">0</span> empleados
                    </div>
                </div>
                
                <!-- Estadísticas de evaluación -->
                <div class="evaluation-stats" id="evaluationStats" style="display: none;">
                    <h4><i class="fas fa-chart-bar"></i> Estadísticas de Evaluación 360°</h4>
                    <div class="stats-row">
                        <span class="stats-label">Máximo evaluaciones por persona:</span>
                        <span class="stats-value" id="maxEvalStat">0</span>
                    </div>
                    <div class="stats-row">
                        <span class="stats-label">Mínimo evaluaciones por persona:</span>
                        <span class="stats-value" id="minEvalStat">0</span>
                    </div>
                    <div class="stats-row">
                        <span class="stats-label">Promedio de evaluaciones:</span>
                        <span class="stats-value" id="avgEvalStat">0.0</span>
                    </div>
                    <div class="stats-row">
                        <span class="stats-label">Total evaluaciones a realizar:</span>
                        <span class="stats-value" id="totalEvalStat">0</span>
                    </div>
                    <p style="margin-top: 10px; font-size: 0.9rem; color: #666;">
                        <i class="fas fa-info-circle"></i> Cada persona evalúa a su jefe (ascendente) y a compañeros (pares)
                    </p>
                </div>
                
                <div class="security-notice">
                    <div>
                        <i class="fas fa-shield-alt"></i>
                        <span>Los datos se borrarán automáticamente en <span id="autoClearTimer">15:00</span> minutos por seguridad.</span>
                        <div class="security-toggle">
                            <label for="autoClearToggle">Auto-borrado:</label>
                            <label class="switch">
                                <input type="checkbox" id="autoClearToggle" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="toggle-anonymize">
                        <label for="anonymizeToggle">Modo anónimo:</label>
                        <label class="switch">
                            <input type="checkbox" id="anonymizeToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                
                <div class="stats-grid" id="statsGrid"></div>
                
                <div class="charts-container">
                    <div class="chart-card">
                        <h3 class="chart-title"><i class="fas fa-venus-mars"></i> Distribución por Género</h3>
                        <div class="chart-container">
                            <canvas id="genderChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-card">
                        <h3 class="chart-title"><i class="fas fa-sitemap"></i> Top 10 Áreas con Más Empleados</h3>
                        <div class="chart-container">
                            <canvas id="areaChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="charts-container">
                    <div class="chart-card">
                        <h3 class="chart-title"><i class="fas fa-user-tie"></i> Distribución de Subordinados por Manager</h3>
                        <div class="chart-container">
                            <canvas id="subordinatesChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-card">
                        <h3 class="chart-title"><i class="fas fa-business-time"></i> Distribución por Años en la Empresa</h3>
                        <div class="chart-container">
                            <canvas id="tenureChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- NUEVO SISTEMA DE TABS -->
                <div class="data-sections">
                    <div class="data-section">
                        <div class="tabs-container">
                            <div class="tabs-header">
                                <div class="tab active" data-tab="inconsistencies">
                                    <i class="fas fa-exclamation-triangle"></i> Inconsistencias
                                    <span id="inconsistenciesCount" class="badge badge-danger" style="margin-left: 8px;">0</span>
                                </div>
                                <div class="tab" data-tab="duplicates">
                                    <i class="fas fa-retweet"></i> Duplicados
                                    <span id="duplicatesCount" class="badge badge-warning" style="margin-left: 8px;">0</span>
                                </div>
                            </div>
                            
                            <!-- Pestaña 1: Inconsistencias -->
                            <div class="tab-content active" id="inconsistenciesTab">
                                <p style="margin-bottom: 15px; color: #666;">Haz clic en cualquier celda para editar el valor. <i class="fas fa-lightbulb" style="color: #ff9800;"></i> indica sugerencias disponibles.</p>
                                <div style="overflow-x: auto;">
                                    <table id="inconsistenciesTable">
                                        <thead>
                                            <tr>
                                                <th>Tipo</th>
                                                <th>Identifier</th>
                                                <th>Nombre</th>
                                                <th>Área</th>
                                                <th>Detalle</th>
                                                <th>Acción</th>
                                            </tr>
                                        </thead>
                                        <tbody id="inconsistenciesBody"></tbody>
                                    </table>
                                </div>
                                <div style="text-align: center; margin-top: 20px;">
                                    <button id="downloadInconsistenciesBtn" class="btn btn-warning" disabled>
                                        <i class="fas fa-download"></i> Descargar Excel de Inconsistencias
                                    </button>
                                    <button id="quickFixBtn" class="btn btn-success" disabled>
                                        <i class="fas fa-magic"></i> Aplicar Correcciones Rápidas
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Pestaña 2: Duplicados (NUEVA) -->
                            <div class="tab-content" id="duplicatesTab">
                                <p style="margin-bottom: 15px; color: #666;">Duplicados detectados por Identifier (CRÍTICO), RUT (IMPORTANTE) y Email (IMPORTANTE).</p>
                                <div style="overflow-x: auto;">
                                    <table id="duplicatesTable">
                                        <thead>
                                            <tr>
                                                <th>Tipo</th>
                                                <th>Valor Duplicado</th>
                                                <th>Registros Afectados</th>
                                                <th>Áreas</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="duplicatesBody"></tbody>
                                    </table>
                                </div>
                                <div style="text-align: center; margin-top: 20px;">
                                    <button id="downloadAllDuplicatesBtn" class="btn btn-warning" disabled>
                                        <i class="fas fa-download"></i> Descargar Excel de Duplicados
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="data-section">
                        <div class="section-header">
                            <h3 class="section-title"><i class="fas fa-user-friends"></i> Top 10 Managers con Más Subordinados</h3>
                            <span class="badge badge-success">Ranking</span>
                        </div>
                        <div style="overflow-x: auto;">
                            <table id="managersTable">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Manager Identifier</th>
                                        <th>Nombre</th>
                                        <th>Subordinados</th>
                                        <th>Área</th>
                                        <th>Carga Evaluación</th>
                                    </tr>
                                </thead>
                                <tbody id="managersBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- SECCIÓN DE DESCARGA (Exportación) -->
                <div class="download-section" id="downloadSection">
                    <h2 style="color: #0d47a1; margin-bottom: 10px;">
                        <i class="fas fa-file-export"></i> Paso 4: Generar Archivos de Exportación
                    </h2>
                    <p style="color: #546e7a; max-width: 800px; margin: 0 auto 20px;">
                        Configura las opciones de exportación y genera los archivos listos para importar en tu sistema de evaluación 360°
                    </p>
                    
                    <div class="export-options">
                        <h3><i class="fas fa-sliders-h"></i> Opciones de Exportación</h3>
                        <div class="option-group">
                            <div class="option-item">
                                <input type="radio" id="formatExcel" name="exportFormat" value="excel" checked>
                                <label for="formatExcel">Formato Excel (.xlsx)</label>
                            </div>
                            <div class="option-item">
                                <input type="radio" id="formatCSV" name="exportFormat" value="csv">
                                <label for="formatCSV">Formato CSV (.csv)</label>
                            </div>
                        </div>
                        
                        <div class="option-group">
                            <div class="option-item">
                                <input type="checkbox" id="segmentByDept">
                                <label for="segmentByDept">Segmentar por departamento/área</label>
                            </div>
                            <div class="option-item">
                                <input type="checkbox" id="includeMetadata">
                                <label for="includeMetadata">Incluir metadatos en archivos</label>
                            </div>
                            <div class="option-item">
                                <input type="checkbox" id="anonymizeExport">
                                <label for="anonymizeExport">Anonimizar datos en exportación</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="download-grid">
                        <div class="download-card">
                            <div class="download-icon">
                                <i class="fas fa-level-up-alt"></i>
                            </div>
                            <h3 class="download-title">Relaciones Ascendentes</h3>
                            <p class="download-desc">Archivo con la relación evaluado (identifier) - evaluador ascendente (manager_identifier)</p>
                            <button id="downloadAscBtn" class="btn btn-success">
                                <i class="fas fa-download"></i> Descargar Ascendentes
                            </button>
                            <p style="margin-top: 10px; font-size: 0.9rem; color: #666;">
                                <i class="fas fa-info-circle"></i> El evaluado evalúa a su jefe directo
                            </p>
                        </div>
                        
                        <div class="download-card">
                            <div class="download-icon">
                                <i class="fas fa-user-friends"></i>
                            </div>
                            <h3 class="download-title">Relaciones de Pares</h3>
                            <p class="download-desc">Archivo con relaciones de pares (formato ancho: una fila por evaluado, columnas Par_1, Par_2...)</p>
                            <button id="downloadPairsBtn" class="btn btn-success">
                                <i class="fas fa-download"></i> Descargar Pares
                            </button>
                            <p style="margin-top: 10px; font-size: 0.9rem; color: #666;">
                                <i class="fas fa-info-circle"></i> Pares = compañeros con el mismo manager (excluyendo al manager)
                            </p>
                        </div>
                        
                        <div class="download-card">
                            <div class="download-icon">
                                <i class="fas fa-chart-pie"></i>
                            </div>
                            <h3 class="download-title">Reporte Ejecutivo</h3>
                            <p class="download-desc">Reporte completo con estadísticas, análisis y recomendaciones para la evaluación 360°</p>
                            <button id="downloadReportBtn" class="btn btn-primary">
                                <i class="fas fa-download"></i> Descargar Reporte
                            </button>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button id="backToAnalysisBtn" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Volver al Análisis
                        </button>
                        <button id="newAnalysisBtn" class="btn btn-primary">
                            <i class="fas fa-plus-circle"></i> Nuevo Análisis
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p><strong>XLS Luxanalitica - HR Analytics Suite</strong> | Herramienta avanzada para análisis de población y evaluaciones 360°</p>
            <p style="margin-top: 10px;">Desarrollado con HTML, CSS, JavaScript, Chart.js y D3.js | Procesamiento 100% en el navegador</p>
        </div>
    </div>

    <!-- Modal de edición -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h3 class="modal-title" id="modalTitle">Editar Valor</h3>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer">
                <button id="cancelEditBtn" class="btn btn-secondary">Cancelar</button>
                <button id="saveEditBtn" class="btn btn-primary">Guardar Cambios</button>
            </div>
        </div>
    </div>

    <!-- Modal de progreso para generación de archivos grandes -->
    <div class="progress-modal" id="progressModal">
        <div class="progress-modal-content">
            <h3 class="progress-title"><i class="fas fa-spinner fa-spin"></i> Generando Archivo de Relaciones</h3>
            <div class="progress-bar-container">
                <div class="progress-bar-fill" id="progressBarFill"></div>
            </div>
            <div class="progress-stats">
                <span id="progressCurrent">0</span> de <span id="progressTotal">0</span> relaciones
                <span id="progressPercentage">0%</span>
            </div>
            <div class="progress-message" id="progressMessage">
                Generando relaciones de evaluación...
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button id="cancelGenerationBtn" class="btn btn-warning">
                    <i class="fas fa-times"></i> Cancelar Generación
                </button>
            </div>
        </div>
    </div>

    <script>
        // ==============================================
        // NUEVO CÓDIGO PARA LAS MEJORAS
        // ==============================================
        
        // Variables para las nuevas funcionalidades
        let currentSection = 'centro-datos'; // Por defecto activamos el Centro de Datos
        let termsAccepted = false;
        
        // Elementos del DOM para las nuevas funcionalidades
        const securityModal = document.getElementById('securityModal');
        const termsCheckbox = document.getElementById('termsCheckbox');
        const accessToolBtn = document.getElementById('accessToolBtn');
        const viewLegalLink = document.getElementById('viewLegalLink');
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const menuItems = document.querySelectorAll('.menu-item');
        const constructionOverlay = document.getElementById('constructionOverlay');
        const closeConstructionBtn = document.getElementById('closeConstructionBtn');
        
        // NUEVOS ELEMENTOS PARA EL PANEL DE CONTACTO
        const contactFloatingBtn = document.getElementById('contactFloatingBtn');
        const contactPanel = document.getElementById('contactPanel');
        const closeContactBtn = document.getElementById('closeContactBtn');
        
        // FUNCIÓN: Inicializar las nuevas funcionalidades
        function initializeEnhancements() {
            // 1. Mostrar modal de seguridad al cargar la página
            showSecurityModal();
            
            // 2. Configurar eventos del modal de seguridad
            termsCheckbox.addEventListener('change', function() {
                accessToolBtn.disabled = !this.checked;
            });
            
            accessToolBtn.addEventListener('click', function() {
                if (termsCheckbox.checked) {
                    termsAccepted = true;
                    securityModal.style.display = 'none';
                    document.body.classList.add('sidebar-expanded');
                    sidebar.classList.add('expanded');
                    activateSection('centro-datos');
                }
            });
            
            viewLegalLink.addEventListener('click', function(e) {
                e.preventDefault();
                const legalTerms = document.getElementById('legalTerms');
                legalTerms.style.maxHeight = legalTerms.style.maxHeight ? '' : '600px';
                this.innerHTML = legalTerms.style.maxHeight ? 
                    '<i class="fas fa-chevron-up"></i> Ocultar Términos Legales' : 
                    '<i class="fas fa-file-contract"></i> Ver Términos Legales y Exención de Responsabilidad';
            });
            
            // 3. Configurar sidebar
            sidebarToggle.addEventListener('click', function() {
                const isExpanded = sidebar.classList.toggle('expanded');
                document.body.classList.toggle('sidebar-expanded', isExpanded);
                this.innerHTML = isExpanded ? '<i class="fas fa-times"></i>' : '<i class="fas fa-bars"></i>';
            });
            
            // 4. Configurar menú items
            menuItems.forEach(item => {
                item.addEventListener('click', function() {
                    const section = this.dataset.section;
                    activateSection(section);
                    
                    // Si no es centro-datos o evaluacion, mostrar construcción
                    if (section !== 'centro-datos' && section !== 'evaluacion') {
                        showConstructionMessage(section);
                    }
                });
            });
            
            // 5. Configurar botón para cerrar mensaje de construcción
            closeConstructionBtn.addEventListener('click', function() {
                constructionOverlay.style.display = 'none';
                activateSection('centro-datos');
            });
            
            // 6. Configurar panel de contacto
            contactFloatingBtn.addEventListener('click', function() {
                contactPanel.classList.toggle('expanded');
                this.innerHTML = contactPanel.classList.contains('expanded') ? 
                    '<i class="fas fa-times"></i>' : '<i class="fas fa-comment-alt"></i>';
            });
            
            closeContactBtn.addEventListener('click', function() {
                contactPanel.classList.remove('expanded');
                contactFloatingBtn.innerHTML = '<i class="fas fa-comment-alt"></i>';
            });
            
            // Cerrar panel de contacto al hacer clic fuera de él
            document.addEventListener('click', function(event) {
                if (!contactPanel.contains(event.target) && !contactFloatingBtn.contains(event.target)) {
                    contactPanel.classList.remove('expanded');
                    contactFloatingBtn.innerHTML = '<i class="fas fa-comment-alt"></i>';
                }
            });
            
            // 7. Por defecto, activar el Centro de Datos
            setTimeout(() => {
                if (termsAccepted) {
                    activateSection('centro-datos');
                }
            }, 100);
        }
        
        // FUNCIÓN: Mostrar modal de seguridad
        function showSecurityModal() {
            // Mostrar siempre al inicio
            securityModal.style.display = 'flex';
            
            // Guardar en localStorage que se ha visto (opcional, para desarrollo)
            localStorage.setItem('securityModalShown', 'true');
        }
        
        // FUNCIÓN: Activar una sección
        function activateSection(section) {
            // Remover active de todos los items del menú
            menuItems.forEach(item => {
                item.classList.remove('active');
            });
            
            // Activar el item correspondiente
            document.querySelector(`.menu-item[data-section="${section}"]`).classList.add('active');
            
            // Actualizar sección actual
            currentSection = section;
            
            // Si es centro-datos, asegurarse de que todo esté visible
            if (section === 'centro-datos') {
                // Asegurar que el contenido principal esté visible
                document.querySelector('.container').style.display = 'block';
                document.querySelector('.main-content').style.display = 'block';
                constructionOverlay.style.display = 'none';
            }
        }
        
        // FUNCIÓN: Mostrar mensaje de construcción
        function showConstructionMessage(section) {
            // Obtener nombre de la sección
            let sectionName = '';
            switch(section) {
                case 'analytics':
                    sectionName = 'Tableros de Analytics';
                    break;
                case 'kpis':
                    sectionName = 'Planificador de KPIs y Bonos';
                    break;
                case 'estructura':
                    sectionName = 'Estructura Organizacional';
                    break;
                default:
                    sectionName = 'Esta sección';
            }
            
            // Actualizar mensaje
            const message = constructionOverlay.querySelector('p');
            message.innerHTML = `Esta funcionalidad estará disponible muy pronto. Estamos trabajando en <strong>${sectionName}</strong> para ofrecerte herramientas avanzadas de People Analytics.`;
            
            // Mostrar overlay
            constructionOverlay.style.display = 'flex';
        }
        
        // ==============================================
        // CÓDIGO ORIGINAL MANTENIDO SIN CAMBIOS
        // ==============================================
        
        // Registrar plugin de datalabels
        Chart.register(ChartDataLabels);
        
        // Variables globales
        let originalData = [];
        let employees = [];
        let inconsistencies = [];
        let duplicates = []; // NUEVA VARIABLE PARA DUPLICADOS
        let stats = {};
        let config = {};
        let genderChart, areaChart, subordinatesChart, tenureChart;
        let autoClearInterval;
        let loadingTimerId = null;
        let loadingStartTime = 0;
        let autoClearTime = 15 * 60;
        let autoClearEnabled = true;
        let isAnonymized = false; // Cambiado a false por defecto
        let currentEdit = null;
        let useAdvancedConfig = false; // Cambiado a false por defecto
        let cancelGeneration = false;
        let processingTime = 0; // Variable para almacenar el tiempo de procesamiento total
        
        // Configuración por defecto - CORREGIDA según tus requerimientos
        const defaultConfig = {
            criteriaSameArea: false, // Desactivado según tu solicitud
            criteriaSameManager: true, // Siempre mismo jefe
            criteriaExcludeManager: true, // Siempre excluir al jefe
            maxParesPerPerson: 1000, // Número muy alto para que no limite
            minAscendentes: 1,
            minPares: 0, // Sin mínimo según tu solicitud
            minSubordinados: 0,
            minTotalEvaluadores: 3,
            maxCarga: 50, // Aumentado para permitir más evaluaciones
            minCobertura: 90,
            detectConflict: true,
            autoBalance: true,
            useAdvancedConfig: false, // Modo simple por defecto
            simpleExcludeManagers: true
        };
        
        // Inicializar configuración
        config = {...defaultConfig};
        
        // Elementos del DOM
        const fileInput = document.getElementById('fileInput');
        const fileName = document.getElementById('fileName');
        const uploadBtn = document.getElementById('uploadBtn');
        const resetBtn = document.getElementById('resetBtn');
        const configSection = document.getElementById('configSection');
        const applyConfigBtn = document.getElementById('applyConfigBtn');
        const backToUploadBtn = document.getElementById('backToUploadBtn');
        const loading = document.getElementById('loading');
        const loadingSecondsEl = document.getElementById('loadingSeconds');
        const loadingEstimate = document.getElementById('loadingEstimate');
        const dashboard = document.getElementById('dashboard');
        const statsGrid = document.getElementById('statsGrid');
        const analysisDate = document.getElementById('analysisDate');
        const inconsistenciesCount = document.getElementById('inconsistenciesCount');
        const inconsistenciesBody = document.getElementById('inconsistenciesBody');
        const managersBody = document.getElementById('managersBody');
        const downloadInconsistenciesBtn = document.getElementById('downloadInconsistenciesBtn');
        const quickFixBtn = document.getElementById('quickFixBtn');
        const downloadAscBtn = document.getElementById('downloadAscBtn');
        const downloadPairsBtn = document.getElementById('downloadPairsBtn');
        const downloadReportBtn = document.getElementById('downloadReportBtn');
        const backToAnalysisBtn = document.getElementById('backToAnalysisBtn');
        const newAnalysisBtn = document.getElementById('newAnalysisBtn');
        const anonymizeToggle = document.getElementById('anonymizeToggle');
        const autoClearToggle = document.getElementById('autoClearToggle');
        const autoClearTimer = document.getElementById('autoClearTimer');
        const editModal = document.getElementById('editModal');
        const closeModal = document.querySelector('.close-modal');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const saveEditBtn = document.getElementById('saveEditBtn');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        const currentDateTime = document.getElementById('currentDateTime');
        const processingTimeEl = document.getElementById('processingTime');
        const finalProcessingTimeEl = document.getElementById('finalProcessingTime');
        const totalProcessedEmployeesEl = document.getElementById('totalProcessedEmployees');
        const evaluationStatsEl = document.getElementById('evaluationStats');
        const maxEvalStat = document.getElementById('maxEvalStat');
        const minEvalStat = document.getElementById('minEvalStat');
        const avgEvalStat = document.getElementById('avgEvalStat');
        const totalEvalStat = document.getElementById('totalEvalStat');
        
        // Elementos de configuración
        const advancedConfigToggle = document.getElementById('advancedConfigToggle');
        const configStatusText = document.getElementById('configStatusText');
        const configWarning = document.getElementById('configWarning');
        const configWarningInactive = document.getElementById('configWarningInactive');
        const configWarningActive = document.getElementById('configWarningActive');
        const configOptions = document.getElementById('configOptions');
        const criteriaSameArea = document.getElementById('criteriaSameArea');
        const criteriaSameManager = document.getElementById('criteriaSameManager');
        const criteriaExcludeManager = document.getElementById('criteriaExcludeManager');
        const maxParesPerPerson = document.getElementById('maxParesPerPerson');
        const minAscendentes = document.getElementById('minAscendentes');
        const minPares = document.getElementById('minPares');
        const minSubordinados = document.getElementById('minSubordinados');
        const minTotalEvaluadores = document.getElementById('minTotalEvaluadores');
        const maxCarga = document.getElementById('maxCarga');
        const minCobertura = document.getElementById('minCobertura');
        const detectConflict = document.getElementById('detectConflict');
        const autoBalance = document.getElementById('autoBalance');
        
        // Elementos de exportación
        const formatExcel = document.getElementById('formatExcel');
        const formatCSV = document.getElementById('formatCSV');
        const segmentByDept = document.getElementById('segmentByDept');
        const includeMetadata = document.getElementById('includeMetadata');
        const anonymizeExport = document.getElementById('anonymizeExport');
        
        // Elementos de progreso
        const steps = document.querySelectorAll('.step');
        const progressBar = document.getElementById('progressBar');
        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const step3 = document.getElementById('step3');
        const step4 = document.getElementById('step4');
        const uploadSection = document.getElementById('uploadSection');
        const downloadSection = document.getElementById('downloadSection');
        
        // Elementos de acordeón de requisitos
        const requirementsHeader = document.getElementById('requirementsHeader');
        const requirementsContent = document.getElementById('requirementsContent');
        const requirementsChevron = document.getElementById('requirementsChevron');
        
        // Elementos de modal de progreso
        const progressModal = document.getElementById('progressModal');
        const progressBarFill = document.getElementById('progressBarFill');
        const progressCurrent = document.getElementById('progressCurrent');
        const progressTotal = document.getElementById('progressTotal');
        const progressPercentage = document.getElementById('progressPercentage');
        const progressMessage = document.getElementById('progressMessage');
        const cancelGenerationBtn = document.getElementById('cancelGenerationBtn');
        
        // NUEVOS ELEMENTOS PARA DUPLICADOS
        const duplicatesCount = document.getElementById('duplicatesCount');
        const duplicatesBody = document.getElementById('duplicatesBody');
        const downloadAllDuplicatesBtn = document.getElementById('downloadAllDuplicatesBtn');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        
        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar mejoras primero
            initializeEnhancements();
            
            // Luego el código original
            updateCurrentDateTime();
            setInterval(updateCurrentDateTime, 1000);
            
            updateAnalysisDate();
            loadConfigToUI();
            
            // Acordeón de requisitos
            requirementsHeader.addEventListener('click', toggleRequirements);
            
            // Event listeners CORREGIDOS
            fileInput.addEventListener('change', handleFileSelect);
            uploadBtn.addEventListener('click', goToConfiguration);
            resetBtn.addEventListener('click', resetApp);
            applyConfigBtn.addEventListener('click', applyConfiguration);
            backToUploadBtn.addEventListener('click', goBackToUpload);
            
            downloadInconsistenciesBtn.addEventListener('click', downloadInconsistencies);
            quickFixBtn.addEventListener('click', applyQuickFixes);
            downloadAscBtn.addEventListener('click', downloadAscendentes);
            downloadPairsBtn.addEventListener('click', () => {
                if (employees.length > 1000) {
                    if (confirm(`⚠️ ADVERTENCIA: Generar relaciones para ${employees.length} empleados puede crear un archivo muy grande. ¿Continuar?`)) {
                        downloadPares();
                    }
                } else {
                    downloadPares();
                }
            });
            downloadReportBtn.addEventListener('click', downloadReporte);
            
            backToAnalysisBtn.addEventListener('click', goBackToAnalysis);
            newAnalysisBtn.addEventListener('click', newAnalysis);
            
            anonymizeToggle.addEventListener('change', toggleAnonymize);
            autoClearToggle.addEventListener('change', toggleAutoClear);
            advancedConfigToggle.addEventListener('change', updateConfigToggleUI);
            
            // Event listeners para modal
            closeModal.addEventListener('click', closeEditModal);
            cancelEditBtn.addEventListener('click', closeEditModal);
            saveEditBtn.addEventListener('click', saveEdit);
            
            // Event listener para cancelar generación
            cancelGenerationBtn.addEventListener('click', function() {
                cancelGeneration = true;
                progressMessage.textContent = "Cancelando generación...";
            });
            
            // NUEVOS EVENT LISTENERS PARA TABS
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    activateTab(tabId);
                });
            });
            
            // Event listener para descargar todos los duplicados
            downloadAllDuplicatesBtn.addEventListener('click', downloadAllDuplicates);
            
            startAutoClearTimer();
            updateProgress(1);
            updateConfigToggleUI();
        });
        
        // NUEVA FUNCIÓN: Activar pestaña
        function activateTab(tabId) {
            // Desactivar todas las pestañas
            tabs.forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Desactivar todos los contenidos
            tabContents.forEach(content => {
                content.classList.remove('active');
            });
            
            // Activar pestaña seleccionada
            document.querySelector(`.tab[data-tab="${tabId}"]`).classList.add('active');
            
            // Activar contenido correspondiente
            document.getElementById(`${tabId}Tab`).classList.add('active');
        }
        
        // Acordeón de requisitos
        function toggleRequirements() {
            const isExpanded = requirementsContent.classList.toggle('expanded');
            requirementsChevron.className = isExpanded ? 'fas fa-chevron-up' : 'fas fa-chevron-down';
        }
        
        // Actualizar fecha y hora actual
        function updateCurrentDateTime() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('es-ES', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric'
            });
            const timeStr = now.toLocaleTimeString('es-ES');
            currentDateTime.textContent = `${dateStr} - ${timeStr}`;
        }
        
        // Actualizar fecha de análisis
        function updateAnalysisDate() {
            const now = new Date();
            analysisDate.textContent = `Análisis realizado el ${now.toLocaleDateString('es-ES', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            })}`;
        }
        
        // Cargar configuración a UI
        function loadConfigToUI() {
            criteriaSameArea.checked = config.criteriaSameArea;
            criteriaSameManager.checked = config.criteriaSameManager;
            criteriaExcludeManager.checked = config.criteriaExcludeManager;
            maxParesPerPerson.value = config.maxParesPerPerson;
            minAscendentes.value = config.minAscendentes;
            minPares.value = config.minPares;
            minSubordinados.value = config.minSubordinados;
            minTotalEvaluadores.value = config.minTotalEvaluadores;
            maxCarga.value = config.maxCarga;
            minCobertura.value = config.minCobertura;
            detectConflict.checked = config.detectConflict;
            autoBalance.checked = config.autoBalance;
            advancedConfigToggle.checked = config.useAdvancedConfig;
        }
        
        // Guardar configuración desde UI
        function saveConfigFromUI() {
            config.criteriaSameArea = criteriaSameArea.checked;
            config.criteriaSameManager = criteriaSameManager.checked;
            config.criteriaExcludeManager = criteriaExcludeManager.checked;
            config.maxParesPerPerson = parseInt(maxParesPerPerson.value);
            config.minAscendentes = parseInt(minAscendentes.value);
            config.minPares = parseInt(minPares.value);
            config.minSubordinados = parseInt(minSubordinados.value);
            config.minTotalEvaluadores = parseInt(minTotalEvaluadores.value);
            config.maxCarga = parseInt(maxCarga.value);
            config.minCobertura = parseInt(minCobertura.value);
            config.detectConflict = detectConflict.checked;
            config.autoBalance = autoBalance.checked;
            config.useAdvancedConfig = useAdvancedConfig;
            config.simpleExcludeManagers = true; // Siempre excluir al jefe en modo simple
        }
        
        // Actualizar UI del toggle de configuración
        function updateConfigToggleUI() {
            useAdvancedConfig = advancedConfigToggle.checked;
            
            if (useAdvancedConfig) {
                configStatusText.textContent = "ACTIVADA";
                configStatusText.style.color = "#4caf50";
                configWarningInactive.style.display = "none";
                configWarningActive.style.display = "block";
                configOptions.style.opacity = "1";
                configOptions.style.pointerEvents = "auto";
            } else {
                configStatusText.textContent = "DESACTIVADA";
                configStatusText.style.color = "#f44336";
                configWarningInactive.style.display = "block";
                configWarningActive.style.display = "none";
                configOptions.style.opacity = "0.6";
                configOptions.style.pointerEvents = "none";
            }
        }
        
        // Alternar auto-borrado
        function toggleAutoClear() {
            autoClearEnabled = autoClearToggle.checked;
            if (autoClearEnabled) {
                startAutoClearTimer();
            } else {
                clearInterval(autoClearInterval);
                autoClearTimer.textContent = "Desactivado";
                autoClearTimer.style.color = "#666";
            }
        }
        
        // Manejar selección de archivo - CORREGIDO
        function handleFileSelect(e) {
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                fileName.textContent = `Archivo seleccionado: ${file.name} (${formatFileSize(file.size)})`;
                uploadBtn.disabled = false;
                console.log("Archivo seleccionado:", file.name);
            } else {
                fileName.textContent = 'No se ha seleccionado ningún archivo';
                uploadBtn.disabled = true;
            }
        }
        
        // Formatear tamaño de archivo
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // Ir a configuración
        function goToConfiguration() {
            if (fileInput.files.length === 0) return;
            
            uploadSection.style.display = 'none';
            configSection.style.display = 'block';
            updateProgress(2);
        }
        
        // Volver a carga
        function goBackToUpload() {
            configSection.style.display = 'none';
            uploadSection.style.display = 'block';
            updateProgress(1);
        }
        
        // Iniciar contador de carga con milisegundos
        function startLoadingTimer() {
            loadingStartTime = performance.now();
            loadingTimerId = requestAnimationFrame(updateLoadingTimer);
        }
        
        // Actualizar contador de carga
        function updateLoadingTimer() {
            const elapsed = performance.now() - loadingStartTime;
            const seconds = (elapsed / 1000).toFixed(3);
            loadingSecondsEl.textContent = seconds;
            processingTime = elapsed / 1000; // Almacenar el tiempo total
            loadingTimerId = requestAnimationFrame(updateLoadingTimer);
        }
        
        // Detener contador de carga
        function stopLoadingTimer() {
            if (loadingTimerId) {
                cancelAnimationFrame(loadingTimerId);
                loadingTimerId = null;
            }
        }
        
        // Aplicar configuración y analizar - CORREGIDO
        function applyConfiguration() {
            // Guardar configuración
            saveConfigFromUI();
            
            const file = fileInput.files[0];
            if (!file) {
                alert('Por favor, selecciona un archivo primero.');
                return;
            }
            
            const reader = new FileReader();
            
            loading.style.display = 'block';
            configSection.style.display = 'none';
            updateProgress(3);
            
            // Estimar líneas totales
            const totalLines = Math.floor(file.size / 100); // Estimación aproximada
            loadingEstimate.innerHTML = `<i class="fas fa-chart-line"></i> Estimación: 1-2 segundos por cada 1,000 líneas`;
            
            startLoadingTimer();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    
                    // Usar setTimeout para permitir que la animación se muestre
                    setTimeout(() => {
                        processData(jsonData);
                        
                        // NUEVO: Detectar duplicados después de procesar datos
                        detectDuplicates();
                        
                        performAnalysis();
                        
                        stopLoadingTimer();
                        loading.style.display = 'none';
                        dashboard.style.display = 'block';
                        
                        // Actualizar tiempo de procesamiento en el dashboard
                        finalProcessingTimeEl.textContent = processingTime.toFixed(3);
                        totalProcessedEmployeesEl.textContent = employees.length;
                        
                        dashboard.scrollIntoView({ behavior: 'smooth' });
                        resetAutoClearTimer();
                        
                    }, 100); // Pequeño delay para UI
                    
                } catch (error) {
                    console.error('Error al procesar el archivo:', error);
                    stopLoadingTimer();
                    alert('Error al procesar el archivo. Asegúrate de que es un archivo Excel válido. Detalle: ' + error.message);
                    loading.style.display = 'none';
                    configSection.style.display = 'block';
                }
            };
            
            reader.onerror = function() {
                console.error('Error al leer el archivo:', reader.error);
                stopLoadingTimer();
                alert('Error al leer el archivo: ' + (reader.error ? reader.error.message : 'Error desconocido'));
                loading.style.display = 'none';
                configSection.style.display = 'block';
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        // Procesar datos del archivo - CORREGIDO
        function processData(jsonData) {
            originalData = jsonData;
            employees = [];
            inconsistencies = [];
            duplicates = []; // Reiniciar duplicados
            
            let headerRow = [];
            let startRow = 0;
            
            if (jsonData.length > 0) {
                const firstRow = jsonData[0];
                const secondRow = jsonData[1] || [];
                
                if (firstRow.length > 0 && typeof firstRow[0] === 'string' && 
                    firstRow[0].toLowerCase().includes('identifier')) {
                    headerRow = firstRow;
                    startRow = 1;
                }
            }
            
            const colIndices = {
                identifier: findColumnIndex(headerRow, 'identifier'),
                rut: findColumnIndex(headerRow, 'rut'),
                nss: findColumnIndex(headerRow, 'nss'),
                curp: findColumnIndex(headerRow, 'curp'),
                civil_status: findColumnIndex(headerRow, 'civil_status'),
                username: findColumnIndex(headerRow, 'username'),
                area: findColumnIndex(headerRow, 'area'),
                area_name: findColumnIndex(headerRow, 'area_name'),
                email: findColumnIndex(headerRow, 'email'),
                personal_email: findColumnIndex(headerRow, 'personal_email'),
                firstname: findColumnIndex(headerRow, 'firstname'),
                middlename: findColumnIndex(headerRow, 'middlename'),
                lastname: findColumnIndex(headerRow, 'lastname'),
                mothername: findColumnIndex(headerRow, 'mothername'),
                display_name: findColumnIndex(headerRow, 'display_name'),
                gender: findColumnIndex(headerRow, 'gender'),
                birthdate: findColumnIndex(headerRow, 'birthdate'),
                joiningdate: findColumnIndex(headerRow, 'joiningdate'),
                subdomain: findColumnIndex(headerRow, 'subdomain'),
                position: findColumnIndex(headerRow, 'position'),
                position_name: findColumnIndex(headerRow, 'position_name'),
                description_position: findColumnIndex(headerRow, 'description_position'),
                manager_identifier: findColumnIndex(headerRow, 'manager_identifier')
            };
            
            const useFixedIndices = Object.values(colIndices).every(index => index === -1);
            
            for (let i = startRow; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (row.length === 0 || (row[0] === '' && row[1] === '')) continue;
                
                let employee = {};
                
                if (useFixedIndices) {
                    employee = {
                        identifier: row[0] !== undefined ? String(row[0]).trim() : '',
                        rut: row[1] !== undefined ? String(row[1]).trim() : '',
                        nss: row[2] !== undefined ? String(row[2]).trim() : '',
                        curp: row[3] !== undefined ? String(row[3]).trim() : '',
                        civil_status: row[4] !== undefined ? String(row[4]).trim() : '',
                        username: row[5] !== undefined ? String(row[5]).trim() : '',
                        area: row[6] !== undefined ? String(row[6]).trim() : '',
                        area_name: row[7] !== undefined ? String(row[7]).trim() : '',
                        email: row[8] !== undefined ? String(row[8]).trim() : '',
                        personal_email: row[9] !== undefined ? String(row[9]).trim() : '',
                        firstname: row[10] !== undefined ? String(row[10]).trim() : '',
                        middlename: row[11] !== undefined ? String(row[11]).trim() : '',
                        lastname: row[12] !== undefined ? String(row[12]).trim() : '',
                        mothername: row[13] !== undefined ? String(row[13]).trim() : '',
                        display_name: row[14] !== undefined ? String(row[14]).trim() : '',
                        gender: row[15] !== undefined ? String(row[15]).trim() : '',
                        birthdate: row[16] !== undefined ? parseDate(row[16]) : null,
                        joiningdate: row[17] !== undefined ? parseDate(row[17]) : null,
                        subdomain: row[18] !== undefined ? String(row[18]).trim() : '',
                        position: row[19] !== undefined ? String(row[19]).trim() : '',
                        position_name: row[20] !== undefined ? String(row[20]).trim() : '',
                        description_position: row[21] !== undefined ? String(row[21]).trim() : '',
                        manager_identifier: row[22] !== undefined ? String(row[22]).trim() : ''
                    };
                } else {
                    employee = {
                        identifier: getCellValue(row, colIndices.identifier),
                        rut: getCellValue(row, colIndices.rut),
                        nss: getCellValue(row, colIndices.nss),
                        curp: getCellValue(row, colIndices.curp),
                        civil_status: getCellValue(row, colIndices.civil_status),
                        username: getCellValue(row, colIndices.username),
                        area: getCellValue(row, colIndices.area),
                        area_name: getCellValue(row, colIndices.area_name),
                        email: getCellValue(row, colIndices.email),
                        personal_email: getCellValue(row, colIndices.personal_email),
                        firstname: getCellValue(row, colIndices.firstname),
                        middlename: getCellValue(row, colIndices.middlename),
                        lastname: getCellValue(row, colIndices.lastname),
                        mothername: getCellValue(row, colIndices.mothername),
                        display_name: getCellValue(row, colIndices.display_name),
                        gender: getCellValue(row, colIndices.gender),
                        birthdate: parseDate(getCellValue(row, colIndices.birthdate)),
                        joiningdate: parseDate(getCellValue(row, colIndices.joiningdate)),
                        subdomain: getCellValue(row, colIndices.subdomain),
                        position: getCellValue(row, colIndices.position),
                        position_name: getCellValue(row, colIndices.position_name),
                        description_position: getCellValue(row, colIndices.description_position),
                        manager_identifier: getCellValue(row, colIndices.manager_identifier)
                    };
                }
                
                validateEmployee(employee, i + 1);
                
                if (employee.identifier) {
                    employees.push(employee);
                }
            }
        }
        
        // NUEVA FUNCIÓN: Detectar duplicados
        function detectDuplicates() {
            duplicates = [];
            
            // Mapa para cada tipo de duplicado
            const identifierMap = {};
            const rutMap = {};
            const emailMap = {};
            
            // Agrupar por identifier (CRÍTICO)
            employees.forEach((emp, index) => {
                if (emp.identifier && emp.identifier.trim() !== '') {
                    if (!identifierMap[emp.identifier]) {
                        identifierMap[emp.identifier] = [];
                    }
                    identifierMap[emp.identifier].push({ ...emp, rowIndex: index + 2 });
                }
                
                if (emp.rut && emp.rut.trim() !== '') {
                    if (!rutMap[emp.rut]) {
                        rutMap[emp.rut] = [];
                    }
                    rutMap[emp.rut].push({ ...emp, rowIndex: index + 2 });
                }
                
                if (emp.email && emp.email.trim() !== '') {
                    if (!emailMap[emp.email]) {
                        emailMap[emp.email] = [];
                    }
                    emailMap[emp.email].push({ ...emp, rowIndex: index + 2 });
                }
            });
            
            // Procesar duplicados de identifier (CRÍTICO)
            Object.keys(identifierMap).forEach(key => {
                if (identifierMap[key].length > 1) {
                    const duplicate = {
                        type: 'CRÍTICO',
                        key: key,
                        field: 'identifier',
                        records: identifierMap[key],
                        affectedCount: identifierMap[key].length,
                        areas: [...new Set(identifierMap[key].map(r => r.area_name || r.area || 'N/A'))]
                    };
                    duplicates.push(duplicate);
                }
            });
            
            // Procesar duplicados de rut (IMPORTANTE)
            Object.keys(rutMap).forEach(key => {
                if (rutMap[key].length > 1) {
                    const duplicate = {
                        type: 'IMPORTANTE',
                        key: key,
                        field: 'rut',
                        records: rutMap[key],
                        affectedCount: rutMap[key].length,
                        areas: [...new Set(rutMap[key].map(r => r.area_name || r.area || 'N/A'))]
                    };
                    duplicates.push(duplicate);
                }
            });
            
            // Procesar duplicados de email (IMPORTANTE)
            Object.keys(emailMap).forEach(key => {
                if (emailMap[key].length > 1) {
                    const duplicate = {
                        type: 'IMPORTANTE',
                        key: key,
                        field: 'email',
                        records: emailMap[key],
                        affectedCount: emailMap[key].length,
                        areas: [...new Set(emailMap[key].map(r => r.area_name || r.area || 'N/A'))]
                    };
                    duplicates.push(duplicate);
                }
            });
            
            // Ordenar duplicados: primero CRÍTICO, luego IMPORTANTE
            duplicates.sort((a, b) => {
                if (a.type === 'CRÍTICO' && b.type !== 'CRÍTICO') return -1;
                if (a.type !== 'CRÍTICO' && b.type === 'CRÍTICO') return 1;
                return b.affectedCount - a.affectedCount;
            });
            
            console.log(`Duplicados detectados: ${duplicates.length}`);
        }
        
        // NUEVA FUNCIÓN: Actualizar tabla de duplicados
        function updateDuplicatesTable() {
            duplicatesBody.innerHTML = '';
            
            if (duplicates.length === 0) {
                duplicatesBody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 30px; color: #666;">
                            <i class="fas fa-check-circle" style="color: #4caf50; font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                            No se han detectado duplicados.
                        </td>
                    </tr>`;
                return;
            }
            
            duplicates.forEach((dup, index) => {
                const row = document.createElement('tr');
                row.className = dup.type === 'CRÍTICO' ? 'error-row' : 'warning-row';
                
                // Formatear la lista de registros afectados
                const affectedList = dup.records.map(r => 
                    `${r.identifier} (${r.display_name || r.firstname || 'Sin nombre'})`
                ).join(', ');
                
                // Limitar la longitud de la lista para no hacer la tabla demasiado ancha
                const shortAffectedList = affectedList.length > 100 ? 
                    affectedList.substring(0, 100) + '...' : affectedList;
                
                // Áreas afectadas
                const areasText = dup.areas.join(', ');
                const shortAreas = areasText.length > 50 ? 
                    areasText.substring(0, 50) + '...' : areasText;
                
                row.innerHTML = `
                    <td>
                        <span class="duplicate-type-badge duplicate-type-${dup.type}">
                            ${dup.type}
                        </span>
                        <br>
                        <small>${dup.field}</small>
                    </td>
                    <td><strong>${dup.key}</strong></td>
                    <td>
                        <strong>${dup.affectedCount} registros:</strong><br>
                        <small title="${affectedList}">${shortAffectedList}</small>
                    </td>
                    <td title="${areasText}">${shortAreas}</td>
                    <td>
                        <button class="btn-investigar" data-index="${index}" title="Descargar Excel con los registros duplicados">
                            <i class="fas fa-search"></i> Investigar
                        </button>
                        <button class="btn-consolidar" data-index="${index}" title="Sugerir consolidación de registros">
                            <i class="fas fa-compress-alt"></i> Sugerir Consolidación
                        </button>
                    </td>
                `;
                duplicatesBody.appendChild(row);
            });
            
            // Event listeners para los botones de duplicados
            document.querySelectorAll('.btn-investigar').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = this.dataset.index;
                    downloadDuplicateInvestigation(index);
                });
            });
            
            document.querySelectorAll('.btn-consolidar').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = this.dataset.index;
                    suggestConsolidation(index);
                });
            });
        }
        
        // NUEVA FUNCIÓN: Descargar investigación de duplicado específico
        function downloadDuplicateInvestigation(index) {
            const dup = duplicates[index];
            if (!dup) return;
            
            const format = document.querySelector('input[name="exportFormat"]:checked').value;
            
            // Crear datos para el Excel
            const data = [
                [`Reporte de Duplicados - ${dup.field}: ${dup.key}`, '', '', '', ''],
                ['Tipo', dup.type],
                ['Campo', dup.field],
                ['Valor Duplicado', dup.key],
                ['Registros Afectados', dup.records.length],
                ['', ''],
                ['Detalle de Registros Duplicados', '', '', '', ''],
                ['Fila', 'Identifier', 'Nombre', 'Área', 'Email', 'RUT', 'Manager']
            ];
            
            dup.records.forEach(record => {
                data.push([
                    record.rowIndex,
                    record.identifier,
                    record.display_name || `${record.firstname} ${record.lastname}`,
                    record.area_name || record.area || 'N/A',
                    record.email || 'N/A',
                    record.rut || 'N/A',
                    record.manager_identifier || 'N/A'
                ]);
            });
            
            if (format === 'excel') {
                const worksheet = XLSX.utils.aoa_to_sheet(data);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Duplicados');
                XLSX.writeFile(workbook, `Duplicados_${dup.field}_${dup.key}.xlsx`);
            } else {
                const csvContent = data.map(row => 
                    row.map(cell => `"${cell}"`).join(',')
                ).join('\n');
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `Duplicados_${dup.field}_${dup.key}.csv`;
                link.click();
            }
        }
        
        // NUEVA FUNCIÓN: Sugerir consolidación
        function suggestConsolidation(index) {
            const dup = duplicates[index];
            if (!dup) return;
            
            // Crear sugerencias de consolidación basadas en los datos
            let suggestion = `Sugerencia de consolidación para ${dup.field}: ${dup.key}\n\n`;
            suggestion += `Se detectaron ${dup.records.length} registros duplicados.\n\n`;
            
            if (dup.field === 'identifier') {
                suggestion += `CRÍTICO: Identifier duplicado. Esto puede causar problemas graves en el sistema.\n`;
                suggestion += `Recomendación: Mantener solo un registro con este identifier y eliminar los demás.\n`;
                suggestion += `Si son empleados diferentes, asignar identifiers únicos.`;
            } else if (dup.field === 'rut') {
                suggestion += `IMPORTANTE: RUT duplicado. Una persona no puede tener múltiples RUTs.\n`;
                suggestion += `Recomendación: Verificar si es el mismo empleado con múltiples registros.\n`;
                suggestion += `Consolidar la información en un solo registro.`;
            } else if (dup.field === 'email') {
                suggestion += `IMPORTANTE: Email duplicado. Un email debe ser único por empleado.\n`;
                suggestion += `Recomendación: Verificar si los empleados comparten email.\n`;
                suggestion += `Asignar emails únicos o consolidar registros si es la misma persona.`;
            }
            
            suggestion += `\n\nUse el botón "Investigar" para descargar los detalles completos.`;
            
            // En una implementación más avanzada, esto podría abrir un modal con opciones
            alert(suggestion);
        }
        
        // NUEVA FUNCIÓN: Descargar todos los duplicados
        function downloadAllDuplicates() {
            if (duplicates.length === 0) return;
            
            const format = document.querySelector('input[name="exportFormat"]:checked').value;
            
            const data = [
                ['Reporte de Todos los Duplicados Detectados', '', '', '', '', ''],
                ['Fecha de generación', new Date().toLocaleString('es-ES')],
                ['Total de duplicados encontrados', duplicates.length],
                ['', ''],
                ['Tipo', 'Campo', 'Valor Duplicado', 'Registros Afectados', 'Áreas Afectadas', 'Detalles']
            ];
            
            duplicates.forEach(dup => {
                const affectedList = dup.records.map(r => 
                    `${r.identifier} (${r.display_name || r.firstname || 'Sin nombre'})`
                ).join('; ');
                
                const areasText = dup.areas.join('; ');
                
                data.push([
                    dup.type,
                    dup.field,
                    dup.key,
                    dup.records.length,
                    areasText,
                    affectedList
                ]);
            });
            
            // Agregar resumen por tipo
            const criticoCount = duplicates.filter(d => d.type === 'CRÍTICO').length;
            const importanteCount = duplicates.filter(d => d.type === 'IMPORTANTE').length;
            
            data.push(['', '', '', '', '', '']);
            data.push(['Resumen por Tipo', '', '', '', '', '']);
            data.push(['CRÍTICO (identifier)', criticoCount, '', '', '', '']);
            data.push(['IMPORTANTE (rut, email)', importanteCount, '', '', '', '']);
            
            if (format === 'excel') {
                const worksheet = XLSX.utils.aoa_to_sheet(data);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Todos_Duplicados');
                XLSX.writeFile(workbook, 'Todos_Duplicados_Detectados.xlsx');
            } else {
                const csvContent = data.map(row => 
                    row.map(cell => `"${cell}"`).join(',')
                ).join('\n');
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'Todos_Duplicados_Detectados.csv';
                link.click();
            }
        }
        
        // Encontrar índice de columna por nombre
        function findColumnIndex(headerRow, columnName) {
            if (!headerRow || headerRow.length === 0) return -1;
            
            for (let i = 0; i < headerRow.length; i++) {
                if (headerRow[i] && typeof headerRow[i] === 'string' && 
                    headerRow[i].toLowerCase().includes(columnName.toLowerCase())) {
                    return i;
                }
            }
            return -1;
        }
        
        // Obtener valor de celda
        function getCellValue(row, index) {
            if (index === -1 || row[index] === undefined || row[index] === null) return '';
            return String(row[index]).trim();
        }
        
        // Parsear fecha - MEJORADO
        function parseDate(dateValue) {
            if (!dateValue) return null;
            
            if (dateValue instanceof Date) return dateValue;
            
            if (typeof dateValue === 'number') {
                const excelEpoch = new Date(1899, 11, 30);
                return new Date(excelEpoch.getTime() + dateValue * 24 * 60 * 60 * 1000);
            }
            
            // Intentar diferentes formatos de fecha
            const parsed = new Date(dateValue);
            if (!isNaN(parsed.getTime())) return parsed;
            
            // Intentar formato dd/mm/yyyy
            const parts = String(dateValue).split(/[/\-.]/);
            if (parts.length === 3) {
                const day = parseInt(parts[0], 10);
                const month = parseInt(parts[1], 10) - 1;
                const year = parseInt(parts[2], 10);
                const altParsed = new Date(year, month, day);
                if (!isNaN(altParsed.getTime())) return altParsed;
            }
            
            return null;
        }
        
        // Validar empleado y detectar inconsistencias
        function validateEmployee(employee, rowNumber) {
            if (!employee.identifier) {
                inconsistencies.push({
                    type: 'CRÍTICO',
                    row: rowNumber,
                    identifier: '',
                    name: 'Sin identifier',
                    area: employee.area_name || 'N/A',
                    detail: `Fila ${rowNumber}: Identifier vacío o no válido`,
                    field: 'identifier',
                    value: '',
                    suggestions: []
                });
                return;
            }
            
            if (employee.gender && !['M', 'F', 'm', 'f'].includes(employee.gender)) {
                inconsistencies.push({
                    type: 'ADVERTENCIA',
                    row: rowNumber,
                    identifier: employee.identifier,
                    name: employee.display_name || `${employee.firstname} ${employee.lastname}`,
                    area: employee.area_name || 'N/A',
                    detail: `Género no válido: "${employee.gender}". Debe ser "M" o "F"`,
                    field: 'gender',
                    value: employee.gender,
                    suggestions: ['M', 'F']
                });
            }
            
            if (employee.manager_identifier) {
                const managerExists = employees.some(emp => emp.identifier === employee.manager_identifier) || 
                                    originalData.some(row => String(row[0]).trim() === employee.manager_identifier);
                
                if (!managerExists && employee.manager_identifier !== employee.identifier) {
                    const suggestions = getManagerSuggestions(employee);
                    
                    inconsistencies.push({
                        type: 'ERROR',
                        row: rowNumber,
                        identifier: employee.identifier,
                        name: employee.display_name || `${employee.firstname} ${employee.lastname}`,
                        area: employee.area_name || 'N/A',
                        detail: `Manager_identifier "${employee.manager_identifier}" no existe en la lista de empleados`,
                        field: 'manager_identifier',
                        value: employee.manager_identifier,
                        suggestions: suggestions
                    });
                }
            } else if (employee.identifier !== 'ADMIN') {
                inconsistencies.push({
                    type: 'ADVERTENCIA',
                    row: rowNumber,
                    identifier: employee.identifier,
                    name: employee.display_name || `${employee.firstname} ${employee.lastname}`,
                    area: employee.area_name || 'N/A',
                    detail: `No tiene manager asignado`,
                    field: 'manager_identifier',
                    value: '',
                    suggestions: getManagerSuggestions(employee)
                });
            }
            
            const criticalFields = ['area', 'position'];
            criticalFields.forEach(field => {
                if (!employee[field] || employee[field].trim() === '') {
                    inconsistencies.push({
                        type: 'ADVERTENCIA',
                        row: rowNumber,
                        identifier: employee.identifier,
                        name: employee.display_name || `${employee.firstname} ${employee.lastname}`,
                        area: employee.area_name || 'N/A',
                        detail: `Campo crítico vacío: ${field}`,
                        field: field,
                        value: '',
                        suggestions: getFieldSuggestions(field, employee)
                    });
                }
            });
        }
        
        // Obtener sugerencias de manager
        function getManagerSuggestions(employee) {
            const suggestions = [];
            
            if (employee.area) {
                const areaManagers = employees.filter(emp => 
                    emp.area === employee.area && 
                    emp.identifier !== employee.identifier &&
                    emp.position && emp.position.toLowerCase().includes('manager')
                );
                
                areaManagers.forEach(mgr => {
                    suggestions.push({
                        value: mgr.identifier,
                        label: `${mgr.display_name || mgr.firstname} (${mgr.position})`
                    });
                });
            }
            
            if (suggestions.length === 0) {
                const commonManagers = employees.filter(emp => 
                    emp.position && (
                        emp.position.toLowerCase().includes('manager') ||
                        emp.position.toLowerCase().includes('director') ||
                        emp.position.toLowerCase().includes('head')
                    )
                ).slice(0, 5);
                
                commonManagers.forEach(mgr => {
                    suggestions.push({
                        value: mgr.identifier,
                        label: `${mgr.display_name || mgr.firstname} (${mgr.position})`
                    });
                });
            }
            
            return suggestions;
        }
        
        // Obtener sugerencias para otros campos
        function getFieldSuggestions(field, employee) {
            if (field === 'area') {
                const areaCounts = {};
                employees.forEach(emp => {
                    if (emp.area) {
                        areaCounts[emp.area] = (areaCounts[emp.area] || 0) + 1;
                    }
                });
                
                return Object.keys(areaCounts)
                    .sort((a, b) => areaCounts[b] - areaCounts[a])
                    .slice(0, 5)
                    .map(area => ({ value: area, label: area }));
            }
            
            return [];
        }
        
        // Detectar ciclos jerárquicos
        function detectHierarchyCycles() {
            const reportingMap = {};
            employees.forEach(emp => {
                if (emp.manager_identifier && emp.manager_identifier !== emp.identifier) {
                    reportingMap[emp.identifier] = emp.manager_identifier;
                }
            });
            
            employees.forEach(emp => {
                if (!emp.manager_identifier || emp.manager_identifier === emp.identifier) return;
                
                const visited = new Set();
                let current = emp.identifier;
                
                while (reportingMap[current]) {
                    if (visited.has(current)) {
                        inconsistencies.push({
                            type: 'CRÍTICO',
                            row: 'N/A',
                            identifier: emp.identifier,
                            name: emp.display_name || `${emp.firstname} ${emp.lastname}`,
                            area: emp.area_name || 'N/A',
                            detail: `Ciclo jerárquico detectado en la cadena de mando`,
                            field: 'manager_identifier',
                            value: emp.manager_identifier,
                            suggestions: []
                        });
                        break;
                    }
                    
                    visited.add(current);
                    current = reportingMap[current];
                    
                    if (current === emp.identifier) {
                        inconsistencies.push({
                            type: 'CRÍTICO',
                            row: 'N/A',
                            identifier: emp.identifier,
                            name: emp.display_name || `${emp.firstname} ${emp.lastname}`,
                            area: emp.area_name || 'N/A',
                            detail: `Ciclo jerárquico: reporta indirectamente a sí mismo`,
                            field: 'manager_identifier',
                            value: emp.manager_identifier,
                            suggestions: []
                        });
                        break;
                    }
                }
            });
        }
        
        // Realizar análisis completo
        function performAnalysis() {
            if (config.detectConflict) {
                detectHierarchyCycles();
            }
            
            calculateStatistics();
            updateUI();
            createCharts();
            updateProgress(4);
            downloadSection.style.display = 'block';
        }
        
        // Calcular estadísticas - MEJORADO con cálculo correcto de edad
        function calculateStatistics() {
            stats = {
                totalEmployees: employees.length,
                withManager: 0,
                withoutManager: 0,
                genderCount: { M: 0, F: 0, Other: 0 },
                areaDistribution: {},
                managerSubordinates: {},
                tenureGroups: { '<1 año': 0, '1-3 años': 0, '3-5 años': 0, '5-10 años': 0, '10+ años': 0 },
                inconsistencies: inconsistencies.length,
                duplicates: duplicates.length, // NUEVA ESTADÍSTICA
                duplicatesByType: { 'CRÍTICO': 0, 'IMPORTANTE': 0 }, // NUEVA ESTADÍSTICA
                evaluationLoad: {},
                coverageStats: {
                    withAscendente: 0,
                    withMinPares: 0,
                    withMinSubordinados: 0,
                    fullyCovered: 0
                },
                // NUEVAS ESTADÍSTICAS DE EVALUACIÓN
                evaluationStats: {
                    maxEvaluations: 0,
                    minEvaluations: Infinity,
                    avgEvaluations: 0,
                    totalEvaluations: 0,
                    evaluationDistribution: {} // Para distribución de carga
                }
            };
            
            employees.forEach(emp => {
                if (emp.gender) {
                    const gender = emp.gender.toUpperCase();
                    if (gender === 'M') stats.genderCount.M++;
                    else if (gender === 'F') stats.genderCount.F++;
                    else stats.genderCount.Other++;
                }
                
                if (emp.manager_identifier && emp.manager_identifier !== emp.identifier) {
                    stats.withManager++;
                    
                    if (!stats.managerSubordinates[emp.manager_identifier]) {
                        stats.managerSubordinates[emp.manager_identifier] = 0;
                    }
                    stats.managerSubordinates[emp.manager_identifier]++;
                    
                    stats.coverageStats.withAscendente++;
                } else {
                    stats.withoutManager++;
                }
                
                const area = emp.area_name || emp.area || 'Sin área';
                if (!stats.areaDistribution[area]) {
                    stats.areaDistribution[area] = 0;
                }
                stats.areaDistribution[area]++;
                
                // Cálculo correcto de antigüedad (tenure) - MEJORADO
                if (emp.joiningdate instanceof Date && !isNaN(emp.joiningdate.getTime())) {
                    const today = new Date();
                    const tenureYears = (today - emp.joiningdate) / (1000 * 60 * 60 * 24 * 365.25);
                    
                    if (tenureYears < 1) stats.tenureGroups['<1 año']++;
                    else if (tenureYears <= 3) stats.tenureGroups['1-3 años']++;
                    else if (tenureYears <= 5) stats.tenureGroups['3-5 años']++;
                    else if (tenureYears <= 10) stats.tenureGroups['5-10 años']++;
                    else stats.tenureGroups['10+ años']++;
                } else {
                    // Si no hay fecha de ingreso, contar como "<1 año"
                    stats.tenureGroups['<1 año']++;
                }
            });
            
            // NUEVO: Calcular estadísticas de duplicados por tipo
            duplicates.forEach(dup => {
                stats.duplicatesByType[dup.type] = (stats.duplicatesByType[dup.type] || 0) + 1;
            });
            
            calculateEvaluationLoad();
            calculateEvaluationStats(); // Nueva función para estadísticas de evaluación
            
            const managersWithSubordinates = Object.keys(stats.managerSubordinates).length;
            stats.avgSubordinates = managersWithSubordinates > 0 ? 
                Object.values(stats.managerSubordinates).reduce((a, b) => a + b, 0) / managersWithSubordinates : 0;
            
            stats.maxSubordinates = Object.values(stats.managerSubordinates).length > 0 ? 
                Math.max(...Object.values(stats.managerSubordinates)) : 0;
            
            stats.minSubordinates = Object.values(stats.managerSubordinates).length > 0 ? 
                Math.min(...Object.values(stats.managerSubordinates)) : 0;
            
            calculateCoverageStats();
            
            stats.topManagers = Object.entries(stats.managerSubordinates)
                .map(([id, count]) => {
                    const emp = employees.find(e => e.identifier === id);
                    return {
                        identifier: id,
                        name: emp ? (emp.display_name || `${emp.firstname} ${emp.lastname}`) : id,
                        area: emp ? (emp.area_name || emp.area || 'N/A') : 'N/A',
                        subordinates: count,
                        evaluationLoad: stats.evaluationLoad[id] || 0
                    };
                })
                .sort((a, b) => b.subordinates - a.subordinates)
                .slice(0, 10);
        }
        
        // Calcular carga de evaluación
        function calculateEvaluationLoad() {
            employees.forEach(emp => {
                stats.evaluationLoad[emp.identifier] = 0;
            });
            
            employees.forEach(emp => {
                if (emp.manager_identifier && emp.manager_identifier !== emp.identifier) {
                    stats.evaluationLoad[emp.manager_identifier] = (stats.evaluationLoad[emp.manager_identifier] || 0) + 1;
                }
            });
            
            stats.overloadedEvaluators = Object.entries(stats.evaluationLoad)
                .filter(([id, load]) => load > config.maxCarga)
                .map(([id, load]) => {
                    const emp = employees.find(e => e.identifier === id);
                    return {
                        identifier: id,
                        name: emp ? (emp.display_name || `${emp.firstname} ${emp.lastname}`) : id,
                        load: load,
                        maxAllowed: config.maxCarga
                    };
                });
        }
        
        // NUEVA FUNCIÓN: Calcular estadísticas de evaluación
        function calculateEvaluationStats() {
            // Inicializar distribución de carga
            for (let i = 1; i <= 10; i++) {
                stats.evaluationStats.evaluationDistribution[i] = 0;
            }
            stats.evaluationStats.evaluationDistribution['11+'] = 0;
            
            // Calcular evaluaciones que cada persona DEBE HACER (como evaluador)
            // Esto incluye: evaluar a sus subordinados + evaluar a sus pares (depende de configuración)
            employees.forEach(emp => {
                let evaluationsToDo = 0;
                
                // Evaluar a subordinados (si es manager)
                if (stats.managerSubordinates[emp.identifier]) {
                    evaluationsToDo += stats.managerSubordinates[emp.identifier];
                }
                
                // Evaluar a su manager (ascendente) - SIEMPRE se evalúa al jefe
                if (emp.manager_identifier && emp.manager_identifier !== emp.identifier) {
                    evaluationsToDo += 1; // Evalúa a su jefe
                }
                
                // Evaluar a pares - todos los compañeros con el mismo manager
                const managerId = emp.manager_identifier || 'SIN_MANAGER';
                const compañeros = employees.filter(other => 
                    other.identifier !== emp.identifier &&
                    other.manager_identifier === managerId &&
                    other.identifier !== emp.manager_identifier
                ).length;
                
                evaluationsToDo += compañeros;
                
                // Actualizar estadísticas
                stats.evaluationStats.totalEvaluations += evaluationsToDo;
                
                if (evaluationsToDo > stats.evaluationStats.maxEvaluations) {
                    stats.evaluationStats.maxEvaluations = evaluationsToDo;
                }
                
                if (evaluationsToDo < stats.evaluationStats.minEvaluations) {
                    stats.evaluationStats.minEvaluations = evaluationsToDo;
                }
                
                // Actualizar distribución
                if (evaluationsToDo <= 10) {
                    stats.evaluationStats.evaluationDistribution[evaluationsToDo]++;
                } else {
                    stats.evaluationStats.evaluationDistribution['11+']++;
                }
            });
            
            // Calcular promedio
            stats.evaluationStats.avgEvaluations = stats.totalEmployees > 0 ? 
                stats.evaluationStats.totalEvaluations / stats.totalEmployees : 0;
            
            // Si minEvaluations sigue siendo Infinity (sin empleados), establecer en 0
            if (stats.evaluationStats.minEvaluations === Infinity) {
                stats.evaluationStats.minEvaluations = 0;
            }
            
            // Mostrar estadísticas en la UI
            maxEvalStat.textContent = stats.evaluationStats.maxEvaluations;
            minEvalStat.textContent = stats.evaluationStats.minEvaluations;
            avgEvalStat.textContent = stats.evaluationStats.avgEvaluations.toFixed(1);
            totalEvalStat.textContent = stats.evaluationStats.totalEvaluations;
            evaluationStatsEl.style.display = 'block';
        }
        
        // Calcular estadísticas de cobertura
        function calculateCoverageStats() {
            if (!config.useAdvancedConfig) {
                stats.coverageStats = {
                    withAscendente: stats.withManager,
                    withMinPares: stats.totalEmployees,
                    withMinSubordinados: Object.keys(stats.managerSubordinates).length,
                    fullyCovered: stats.totalEmployees
                };
                return;
            }
            
            employees.forEach(emp => {
                let potentialPares = 0;
                employees.forEach(other => {
                    if (other.identifier === emp.identifier) return;
                    
                    let isPar = true;
                    
                    if (config.criteriaSameArea && emp.area !== other.area) {
                        isPar = false;
                    }
                    
                    if (config.criteriaSameManager && emp.manager_identifier !== other.manager_identifier) {
                        isPar = false;
                    }
                    
                    if (config.criteriaExcludeManager && other.identifier === emp.manager_identifier) {
                        isPar = false;
                    }
                    
                    if (isPar) potentialPares++;
                });
                
                const subordinados = Object.entries(stats.managerSubordinates)
                    .filter(([managerId, count]) => managerId === emp.identifier)
                    .reduce((sum, [, count]) => sum + count, 0);
                
                const hasAscendente = emp.manager_identifier && emp.manager_identifier !== emp.identifier;
                const hasMinPares = potentialPares >= config.minPares;
                const hasMinSubordinados = subordinados >= config.minSubordinados;
                const hasMinTotal = (hasAscendente ? 1 : 0) + Math.min(potentialPares, config.maxParesPerPerson) + subordinados >= config.minTotalEvaluadores;
                
                if (hasAscendente) stats.coverageStats.withAscendente++;
                if (hasMinPares) stats.coverageStats.withMinPares++;
                if (hasMinSubordinados) stats.coverageStats.withMinSubordinados++;
                if (hasAscendente && hasMinPares && hasMinSubordinados && hasMinTotal) {
                    stats.coverageStats.fullyCovered++;
                }
            });
        }
        
        // Calcular porcentajes
        function calculatePercentages() {
            const genderMPercentage = stats.totalEmployees > 0 ? 
                Math.round((stats.genderCount.M / stats.totalEmployees) * 1000) / 10 : 0;
            const genderFPercentage = stats.totalEmployees > 0 ? 
                Math.round((stats.genderCount.F / stats.totalEmployees) * 1000) / 10 : 0;
            const genderOtherPercentage = stats.totalEmployees > 0 ? 
                Math.round((stats.genderCount.Other / stats.totalEmployees) * 1000) / 10 : 0;
            
            const withManagerPercentage = stats.totalEmployees > 0 ? 
                Math.round((stats.withManager / stats.totalEmployees) * 1000) / 10 : 0;
            
            const coveragePercentage = stats.totalEmployees > 0 ? 
                Math.round((stats.coverageStats.fullyCovered / stats.totalEmployees) * 1000) / 10 : 0;
            
            const totalEvaluators = Object.keys(stats.evaluationLoad).length;
            const overloadPercentage = totalEvaluators > 0 ? 
                Math.round((stats.overloadedEvaluators.length / totalEvaluators) * 1000) / 10 : 0;
            
            const inconsistenciesPercentage = stats.totalEmployees > 0 ? 
                Math.round((stats.inconsistencias / stats.totalEmployees) * 1000) / 10 : 0;
            
            // NUEVO: Porcentaje de duplicados
            const duplicatesPercentage = stats.totalEmployees > 0 ? 
                Math.round((stats.duplicates / stats.totalEmployees) * 1000) / 10 : 0;
            
            return {
                genderMPercentage,
                genderFPercentage,
                genderOtherPercentage,
                withManagerPercentage,
                coveragePercentage,
                overloadPercentage,
                inconsistenciesPercentage,
                duplicatesPercentage
            };
        }
        
        // Actualizar UI
        function updateUI() {
            inconsistenciesCount.textContent = stats.inconsistencias;
            duplicatesCount.textContent = stats.duplicates; // NUEVO
            downloadInconsistenciesBtn.disabled = stats.inconsistencias === 0;
            quickFixBtn.disabled = stats.inconsistencias === 0;
            downloadAllDuplicatesBtn.disabled = stats.duplicates === 0; // NUEVO
            
            updateInconsistenciesTable();
            updateDuplicatesTable(); // NUEVO
            updateManagersTable();
            updateStatsCards();
            
            downloadAscBtn.disabled = false;
            downloadPairsBtn.disabled = false;
            downloadReportBtn.disabled = false;
        }
        
        // Actualizar tabla de inconsistencias
        function updateInconsistenciesTable() {
            inconsistenciesBody.innerHTML = '';
            inconsistencies.slice(0, 50).forEach((item, index) => {
                const row = document.createElement('tr');
                row.className = item.type === 'CRÍTICO' ? 'error-row' : 
                               item.type === 'ERROR' ? 'error-row' : 'warning-row';
                row.dataset.index = index;
                
                const hasSuggestions = item.suggestions && item.suggestions.length > 0;
                const suggestionIcon = hasSuggestions ? 
                    '<i class="fas fa-lightbulb" style="color: #ff9800; margin-left: 5px;" title="Sugerencias disponibles"></i>' : '';
                
                row.innerHTML = `
                    <td><span class="badge ${item.type === 'CRÍTICO' ? 'badge-danger' : 
                                           item.type === 'ERROR' ? 'badge-danger' : 'badge-warning'}">${item.type}</span></td>
                    <td class="edit-cell" data-field="identifier" data-index="${index}">
                        <strong>${item.identifier || 'N/A'}</strong>
                        <span class="edit-icon"><i class="fas fa-edit"></i></span>
                    </td>
                    <td class="edit-cell" data-field="name" data-index="${index}">
                        ${isAnonymized ? '***' : (item.name || 'N/A')}
                        <span class="edit-icon"><i class="fas fa-edit"></i></span>
                    </td>
                    <td class="edit-cell" data-field="area" data-index="${index}">
                        ${item.area}
                        <span class="edit-icon"><i class="fas fa-edit"></i></span>
                    </td>
                    <td>${item.detail}${suggestionIcon}</td>
                    <td>
                        ${hasSuggestions ? 
                            `<button class="btn-suggestion" data-index="${index}" style="padding: 5px 10px; font-size: 0.8rem; background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                <i class="fas fa-magic"></i> Sugerir
                            </button>` : 
                            '<span style="color: #999;">-</span>'
                        }
                    </td>
                `;
                inconsistenciesBody.appendChild(row);
            });
            
            if (inconsistencies.length > 50) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="6" style="text-align: center; font-style: italic;">... y ${inconsistencies.length - 50} inconsistencias más</td>`;
                inconsistenciesBody.appendChild(row);
            }
            
            document.querySelectorAll('.edit-cell').forEach(cell => {
                cell.addEventListener('click', function(e) {
                    const index = this.dataset.index;
                    const field = this.dataset.field;
                    openEditModal(index, field);
                });
            });
            
            document.querySelectorAll('.btn-suggestion').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const index = this.dataset.index;
                    applySuggestion(index);
                });
            });
        }
        
        // Actualizar tabla de managers
        function updateManagersTable() {
            managersBody.innerHTML = '';
            stats.topManagers.forEach((manager, index) => {
                const row = document.createElement('tr');
                const loadClass = manager.evaluationLoad > config.maxCarga ? 'badge-danger' : 
                                 manager.evaluationLoad > config.maxCarga * 0.7 ? 'badge-warning' : 'badge-success';
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td><strong>${manager.identifier}</strong></td>
                    <td>${isAnonymized ? '***' : manager.name}</td>
                    <td><span class="badge badge-success">${manager.subordinates} subordinados</span></td>
                    <td>${manager.area}</td>
                    <td><span class="badge ${loadClass}">${manager.evaluationLoad} evaluaciones</span></td>
                `;
                managersBody.appendChild(row);
            });
        }
        
        // Actualizar tarjetas de estadísticas - MEJORADA con duplicados
        function updateStatsCards() {
            const percentages = calculatePercentages();
            const coveragePercentage = stats.coverageStats.fullyCovered > 0 ? 
                Math.round(stats.coverageStats.fullyCovered / stats.totalEmployees * 100) : 0;
            
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-title"><i class="fas fa-users"></i> Total Empleados</div>
                    <div class="stat-value">${stats.totalEmployees}</div>
                    <div class="stat-desc">100% de la población analizada</div>
                </div>
                
                <div class="stat-card ${stats.withManager / stats.totalEmployees > 0.9 ? 'success' : 'warning'}">
                    <div class="stat-title"><i class="fas fa-user-tie"></i> Con Manager Asignado</div>
                    <div class="stat-value ${stats.withManager / stats.totalEmployees > 0.9 ? 'success' : 'warning'}">
                        ${stats.withManager} 
                        <span class="percentage">(${percentages.withManagerPercentage}%)</span>
                    </div>
                    <div class="stat-desc">${stats.withManager} de ${stats.totalEmployees} empleados</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-title"><i class="fas fa-venus-mars"></i> Distribución de Género</div>
                    <div class="stat-value">
                        <div class="gender-display">
                            <span>Masculino: ${stats.genderCount.M}</span>
                            <span class="percentage-badge">${percentages.genderMPercentage}%</span>
                        </div>
                        <div class="gender-bar" style="width: ${percentages.genderMPercentage}%"></div>
                        
                        <div class="gender-display">
                            <span>Femenino: ${stats.genderCount.F}</span>
                            <span class="percentage-badge">${percentages.genderFPercentage}%</span>
                        </div>
                        <div class="gender-bar" style="width: ${percentages.genderFPercentage}%"></div>
                        
                        ${stats.genderCount.Other > 0 ? `
                            <div class="gender-display">
                                <span>Otro: ${stats.genderCount.Other}</span>
                                <span class="percentage-badge">${percentages.genderOtherPercentage}%</span>
                            </div>
                            <div class="gender-bar" style="width: ${percentages.genderOtherPercentage}%"></div>
                        ` : ''}
                    </div>
                    <div class="stat-desc">Total: ${stats.totalEmployees} empleados</div>
                </div>
                
                <div class="stat-card ${coveragePercentage >= config.minCobertura ? 'success' : 'danger'}">
                    <div class="stat-title"><i class="fas fa-check-circle"></i> Cobertura 360° Completa</div>
                    <div class="stat-value ${coveragePercentage >= config.minCobertura ? 'success' : 'danger'}">
                        ${stats.coverageStats.fullyCovered}
                        <span class="percentage">(${percentages.coveragePercentage}%)</span>
                    </div>
                    <div class="stat-desc">${stats.coverageStats.fullyCovered} empleados con evaluación completa</div>
                </div>
                
                <!-- NUEVA ESTADÍSTICA: Duplicados Detectados -->
                <div class="stat-card ${stats.duplicates > 0 ? 'danger' : 'success'}">
                    <div class="stat-title"><i class="fas fa-copy"></i> Duplicados Detectados</div>
                    <div class="stat-value ${stats.duplicates > 0 ? 'danger' : 'success'}">
                        ${stats.duplicates}
                        <span class="percentage">(${percentages.duplicatesPercentage}%)</span>
                    </div>
                    <div class="stat-desc">
                        CRÍTICO: ${stats.duplicatesByType?.CRÍTICO || 0} | 
                        IMPORTANTE: ${stats.duplicatesByType?.IMPORTANTE || 0}
                    </div>
                </div>
                
                <div class="stat-card ${stats.evaluationStats.avgEvaluations > 10 ? 'warning' : 'success'}">
                    <div class="stat-title"><i class="fas fa-chart-bar"></i> Evaluaciones por Persona</div>
                    <div class="stat-value ${stats.evaluationStats.avgEvaluations > 10 ? 'warning' : 'success'}">
                        Máx: ${stats.evaluationStats.maxEvaluations}<br>
                        Mín: ${stats.evaluationStats.minEvaluations}<br>
                        Prom: ${stats.evaluationStats.avgEvaluations.toFixed(1)}
                    </div>
                    <div class="stat-desc">Cantidad de evaluaciones que debe realizar cada persona</div>
                </div>
                
                <div class="stat-card ${percentages.overloadPercentage > 10 ? 'warning' : 'success'}">
                    <div class="stat-title"><i class="fas fa-exclamation-triangle"></i> Evaluadores Sobrecargados</div>
                    <div class="stat-value ${percentages.overloadPercentage > 10 ? 'warning' : 'success'}">
                        ${stats.overloadedEvaluators ? stats.overloadedEvaluators.length : 0}
                        <span class="percentage">(${percentages.overloadPercentage}%)</span>
                    </div>
                    <div class="stat-desc">Con más de ${config.maxCarga} evaluaciones asignadas</div>
                </div>
                
                <div class="stat-card ${stats.inconsistencias > 0 ? 'danger' : 'success'}">
                    <div class="stat-title"><i class="fas fa-exclamation-circle"></i> Inconsistencias Detectadas</div>
                    <div class="stat-value ${stats.inconsistencias > 0 ? 'danger' : 'success'}">
                        ${stats.inconsistencias}
                        <span class="percentage">(${percentages.inconsistenciesPercentage}%)</span>
                    </div>
                    <div class="stat-desc">Problemas que requieren atención</div>
                </div>
            `;
        }
        
        // Crear gráficos MEJORADOS (con gráfico de años en la empresa)
        function createCharts() {
            if (genderChart) genderChart.destroy();
            if (areaChart) areaChart.destroy();
            if (subordinatesChart) subordinatesChart.destroy();
            if (tenureChart) tenureChart.destroy();
            
            // Gráfico de género MEJORADO
            const genderCtx = document.getElementById('genderChart').getContext('2d');
            const genderTotal = stats.genderCount.M + stats.genderCount.F + stats.genderCount.Other;
            
            genderChart = new Chart(genderCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Masculino', 'Femenino', 'Otro/No definido'],
                    datasets: [{
                        data: [stats.genderCount.M, stats.genderCount.F, stats.genderCount.Other],
                        backgroundColor: ['#1565c0', '#e91e63', '#9e9e9e'],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const percentage = Math.round((value / genderTotal) * 100);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        },
                        datalabels: {
                            color: 'white',
                            font: {
                                weight: 'bold',
                                size: 14
                            },
                            formatter: function(value, context) {
                                const percentage = Math.round((value / genderTotal) * 100);
                                return percentage + '%';
                            }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
            
            // Gráfico de áreas (top 10) MEJORADO
            const areaLabels = Object.entries(stats.areaDistribution)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10)
                .map(([area]) => area.length > 20 ? area.substring(0, 20) + '...' : area);
            
            const areaData = Object.entries(stats.areaDistribution)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10)
                .map(([, count]) => count);
            
            const areaColors = areaLabels.map((_, i) => {
                const hue = (i * 30) % 360;
                return `hsl(${hue}, 70%, 60%)`;
            });
            
            const areaCtx = document.getElementById('areaChart').getContext('2d');
            const areaTotal = areaData.reduce((a, b) => a + b, 0);
            
            areaChart = new Chart(areaCtx, {
                type: 'bar',
                data: {
                    labels: areaLabels,
                    datasets: [{
                        label: 'Empleados',
                        data: areaData,
                        backgroundColor: areaColors,
                        borderColor: areaColors.map(color => color.replace('60%)', '40%)')),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw || 0;
                                    const percentage = Math.round((value / areaTotal) * 100);
                                    return `${value} empleados (${percentage}%)`;
                                }
                            }
                        },
                        datalabels: {
                            color: '#333',
                            anchor: 'end',
                            align: 'top',
                            font: {
                                weight: 'bold',
                                size: 11
                            },
                            formatter: function(value, context) {
                                const percentage = Math.round((value / areaTotal) * 100);
                                return percentage + '%';
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Número de Empleados'
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 0
                            }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
            
            // Gráfico de distribución de subordinados MEJORADO
            const subordData = Object.values(stats.managerSubordinates);
            const subordRanges = { '1-3': 0, '4-7': 0, '8-12': 0, '13-20': 0, '21+': 0 };
            
            subordData.forEach(count => {
                if (count <= 3) subordRanges['1-3']++;
                else if (count <= 7) subordRanges['4-7']++;
                else if (count <= 12) subordRanges['8-12']++;
                else if (count <= 20) subordRanges['13-20']++;
                else subordRanges['21+']++;
            });
            
            const subordCtx = document.getElementById('subordinatesChart').getContext('2d');
            const subordTotal = Object.values(subordRanges).reduce((a, b) => a + b, 0);
            
            subordinatesChart = new Chart(subordCtx, {
                type: 'pie',
                data: {
                    labels: ['1-3 subord', '4-7 subord', '8-12 subord', '13-20 subord', '21+ subord'],
                    datasets: [{
                        data: Object.values(subordRanges),
                        backgroundColor: ['#4caf50', '#8bc34a', '#ffc107', '#ff9800', '#f44336'],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const percentage = Math.round((value / subordTotal) * 100);
                                    return `${label}: ${value} managers (${percentage}%)`;
                                }
                            }
                        },
                        datalabels: {
                            color: 'white',
                            font: {
                                weight: 'bold',
                                size: 12
                            },
                            formatter: function(value, context) {
                                const percentage = Math.round((value / subordTotal) * 100);
                                return percentage + '%';
                            }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
            
            // NUEVO GRÁFICO: Años en la empresa
            const tenureCtx = document.getElementById('tenureChart').getContext('2d');
            const tenureTotal = Object.values(stats.tenureGroups).reduce((a, b) => a + b, 0);
            
            tenureChart = new Chart(tenureCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(stats.tenureGroups),
                    datasets: [{
                        label: 'Empleados por Antigüedad',
                        data: Object.values(stats.tenureGroups),
                        backgroundColor: 'rgba(76, 175, 80, 0.7)',
                        borderColor: '#4caf50',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw || 0;
                                    const percentage = Math.round((value / tenureTotal) * 100);
                                    return `${value} empleados (${percentage}%)`;
                                }
                            }
                        },
                        datalabels: {
                            color: '#333',
                            anchor: 'end',
                            align: 'top',
                            font: {
                                weight: 'bold',
                                size: 11
                            },
                            formatter: function(value, context) {
                                const percentage = Math.round((value / tenureTotal) * 100);
                                return percentage + '%';
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Número de Empleados'
                            }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }
        
        // Actualizar progreso
        function updateProgress(step) {
            steps.forEach((s, index) => {
                if (index + 1 < step) {
                    s.classList.add('completed');
                    s.classList.remove('active');
                } else if (index + 1 === step) {
                    s.classList.add('active');
                    s.classList.remove('completed');
                } else {
                    s.classList.remove('active', 'completed');
                }
            });
            
            const progressPercentage = ((step - 1) / 3) * 100;
            progressBar.style.width = `${progressPercentage}%`;
        }
        
        // Iniciar temporizador de auto-borrado
        function startAutoClearTimer() {
            if (!autoClearEnabled) return;
            
            updateAutoClearTimer();
            autoClearInterval = setInterval(updateAutoClearTimer, 1000);
        }
        
        // Actualizar temporizador de auto-borrado
        function updateAutoClearTimer() {
            if (!autoClearEnabled) return;
            
            autoClearTime--;
            
            if (autoClearTime <= 0) {
                clearInterval(autoClearInterval);
                autoClearTimer.textContent = '00:00';
                alert('Los datos se han borrado automáticamente por seguridad.');
                resetApp();
                return;
            }
            
            const minutes = Math.floor(autoClearTime / 60);
            const seconds = autoClearTime % 60;
            autoClearTimer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Cambiar color según tiempo restante
            if (autoClearTime < 300) { // 5 minutos
                autoClearTimer.style.color = '#d32f2f';
                autoClearTimer.style.fontWeight = 'bold';
            } else if (autoClearTime < 600) { // 10 minutos
                autoClearTimer.style.color = '#f57c00';
            } else {
                autoClearTimer.style.color = '#e65100';
            }
        }
        
        // Reiniciar temporizador de auto-borrado
        function resetAutoClearTimer() {
            autoClearTime = 15 * 60;
            updateAutoClearTimer();
        }
        
        // Alternar modo anónimo
        function toggleAnonymize() {
            isAnonymized = anonymizeToggle.checked;
            updateUI();
        }
        
        // Abrir modal de edición
        function openEditModal(index, field) {
            const item = inconsistencies[index];
            if (!item) return;
            
            currentEdit = { index, field };
            modalTitle.textContent = `Editar ${field}`;
            
            let html = `
                <p><strong>Empleado:</strong> ${item.name} (${item.identifier})</p>
                <p><strong>Problema:</strong> ${item.detail}</p>
                <div style="margin-top: 20px;">
                    <label><strong>Nuevo valor:</strong></label>`;
            
            if (item.suggestions && item.suggestions.length > 0) {
                html += `<select id="editValue" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;">`;
                html += `<option value="">-- Seleccionar --</option>`;
                item.suggestions.forEach(suggestion => {
                    const label = typeof suggestion === 'object' ? suggestion.label : suggestion;
                    const value = typeof suggestion === 'object' ? suggestion.value : suggestion;
                    html += `<option value="${value}">${label}</option>`;
                });
                html += `</select>`;
            } else {
                html += `<input type="text" id="editValue" value="${item.value || ''}" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;">`;
            }
            
            modalBody.innerHTML = html;
            editModal.style.display = 'block';
        }
        
        // Cerrar modal de edición
        function closeEditModal() {
            editModal.style.display = 'none';
            currentEdit = null;
        }
        
        // Guardar edición
        function saveEdit() {
            if (!currentEdit) return;
            
            const { index, field } = currentEdit;
            const item = inconsistencies[index];
            if (!item) return;
            
            const editValue = document.getElementById('editValue');
            const newValue = editValue.value;
            
            if (!newValue) {
                alert('Por favor, ingresa un valor.');
                return;
            }
            
            const employee = employees.find(emp => emp.identifier === item.identifier);
            if (employee && item.field) {
                employee[item.field] = newValue;
                
                if (item.field === 'manager_identifier') {
                    // Volver a detectar duplicados si se cambió un identifier
                    detectDuplicates();
                    performAnalysis();
                }
                
                inconsistencies.splice(index, 1);
                updateUI();
                
                alert('Valor actualizado correctamente.');
            }
            
            closeEditModal();
        }
        
        // Aplicar sugerencia
        function applySuggestion(index) {
            const item = inconsistencies[index];
            if (!item || !item.suggestions || item.suggestions.length === 0) return;
            
            const suggestion = item.suggestions[0];
            const newValue = typeof suggestion === 'object' ? suggestion.value : suggestion;
            
            const employee = employees.find(emp => emp.identifier === item.identifier);
            if (employee && item.field) {
                employee[item.field] = newValue;
                
                // Volver a detectar duplicados si se cambió un identifier
                if (item.field === 'identifier' || item.field === 'rut' || item.field === 'email') {
                    detectDuplicates();
                }
                
                inconsistencies.splice(index, 1);
                updateUI();
                
                alert('Sugerencia aplicada correctamente.');
            }
        }
        
        // Aplicar correcciones rápidas
        function applyQuickFixes() {
            let fixedCount = 0;
            
            const fixableItems = inconsistencies.filter(item => 
                item.suggestions && item.suggestions.length > 0 && 
                item.type !== 'CRÍTICO'
            );
            
            fixableItems.forEach(item => {
                const employee = employees.find(emp => emp.identifier === item.identifier);
                if (employee && item.field && item.suggestions.length > 0) {
                    const suggestion = item.suggestions[0];
                    const newValue = typeof suggestion === 'object' ? suggestion.value : suggestion;
                    employee[item.field] = newValue;
                    fixedCount++;
                }
            });
            
            inconsistencies = inconsistencies.filter(item => 
                !fixableItems.includes(item)
            );
            
            // Volver a detectar duplicados después de correcciones
            detectDuplicates();
            performAnalysis();
            
            alert(`Se aplicaron ${fixedCount} correcciones rápidas.`);
        }
        
        // Descargar inconsistencias
        function downloadInconsistencies() {
            if (inconsistencies.length === 0) return;
            
            const format = document.querySelector('input[name="exportFormat"]:checked').value;
            
            const data = [
                ['Tipo', 'Fila', 'Identifier', 'Nombre', 'Área', 'Detalle', 'Campo', 'Valor Actual']
            ];
            
            inconsistencies.forEach(item => {
                data.push([
                    item.type,
                    item.row,
                    item.identifier,
                    anonymizeExport.checked ? '***' : item.name,
                    item.area,
                    item.detail,
                    item.field || '',
                    item.value || ''
                ]);
            });
            
            if (format === 'excel') {
                const worksheet = XLSX.utils.aoa_to_sheet(data);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Inconsistencias');
                XLSX.writeFile(workbook, 'Inconsistencias_Analisis_360.xlsx');
            } else {
                const csvContent = data.map(row => 
                    row.map(cell => `"${cell}"`).join(',')
                ).join('\n');
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'Inconsistencias_Analisis_360.csv';
                link.click();
            }
        }
        
        // FUNCIÓN MEJORADA: Generar relaciones de pares en formato ancho - SEGÚN TUS REQUERIMIENTOS
        async function generatePairsOptimized() {
            const pairsMap = {};
            const totalEmployees = employees.length;
            
            // Mostrar modal de progreso
            cancelGeneration = false;
            progressModal.style.display = 'block';
            progressTotal.textContent = totalEmployees.toLocaleString();
            progressCurrent.textContent = '0';
            progressBarFill.style.width = '0%';
            progressPercentage.textContent = '0%';
            progressMessage.textContent = 'Generando relaciones de pares en formato ancho...';
            
            // Construir mapa de empleados por manager para acceso rápido
            const employeesByManager = {};
            employees.forEach(emp => {
                const managerId = emp.manager_identifier || 'SIN_MANAGER';
                if (!employeesByManager[managerId]) {
                    employeesByManager[managerId] = [];
                }
                employeesByManager[managerId].push(emp);
            });
            
            console.log("Generando relaciones de pares según tus requerimientos: Mismo manager, excluyendo al manager, sin límites");
            
            // Procesar cada empleado
            for (let i = 0; i < totalEmployees; i++) {
                if (cancelGeneration) break;
                
                const emp = employees[i];
                const paresList = [];
                
                // Encontrar compañeros con el mismo manager
                const managerId = emp.manager_identifier || 'SIN_MANAGER';
                const compañeros = employeesByManager[managerId] || [];
                
                // Para cada compañero (excluyendo al empleado actual y al manager)
                for (let j = 0; j < compañeros.length; j++) {
                    if (cancelGeneration) break;
                    
                    const compañero = compañeros[j];
                    
                    // No incluirse a sí mismo
                    if (compañero.identifier === emp.identifier) continue;
                    
                    // No incluir al manager (si el manager está en la lista de compañeros)
                    if (compañero.identifier === emp.manager_identifier) continue;
                    
                    // INCLUIR TODOS los compañeros sin importar área - SEGÚN TUS REQUERIMIENTOS
                    paresList.push(compañero.identifier);
                }
                
                // Agrupar por evaluado
                pairsMap[emp.identifier] = {
                    evaluado: emp.identifier,
                    area: emp.area_name || emp.area || 'N/A',
                    manager: emp.manager_identifier || 'SIN_MANAGER',
                    pares: paresList
                };
                
                // Actualizar progreso
                const progress = Math.min(100, ((i + 1) / totalEmployees) * 100);
                progressBarFill.style.width = `${progress}%`;
                progressCurrent.textContent = (i + 1).toLocaleString();
                progressPercentage.textContent = `${Math.round(progress)}%`;
                
                // Liberar el hilo principal para que se actualice la UI
                if (i % 50 === 0) {
                    await new Promise(resolve => setTimeout(resolve, 0));
                }
            }
            
            console.log(`Generadas relaciones para ${Object.keys(pairsMap).length} evaluados (mismo manager, excluyendo al manager, sin límites)`);
            
            // Cerrar modal de progreso
            progressModal.style.display = 'none';
            
            if (cancelGeneration) {
                alert("Generación cancelada por el usuario.");
                return {pairsArray: [], pairsMap: {}};
            }
            
            // Calcular estadísticas de cobertura de pares
            let totalPares = 0;
            let empleadosSinPares = 0;
            let empleadosConParesSuficientes = 0;
            
            Object.values(pairsMap).forEach(item => {
                totalPares += item.pares.length;
                if (item.pares.length === 0) {
                    empleadosSinPares++;
                }
                if (item.pares.length >= 1) { // Al menos 1 par
                    empleadosConParesSuficientes++;
                }
            });
            
            console.log(`Estadísticas de pares: Total=${totalPares}, SinPares=${empleadosSinPares}, ConSuficientes=${empleadosConParesSuficientes}`);
            
            return {pairsArray: [], pairsMap};
        }
        
        // FUNCIÓN MEJORADA: Descargar relaciones de pares en formato ancho
        async function downloadPares() {
            const format = document.querySelector('input[name="exportFormat"]:checked').value;
            const segment = segmentByDept.checked;
            const anonymize = anonymizeExport.checked;
            
            // Generar pares optimizados
            const {pairsArray, pairsMap} = await generatePairsOptimized();
            
            if (Object.keys(pairsMap).length === 0) return;
            
            if (segment) {
                // Segmentar por área
                const areas = {};
                
                Object.values(pairsMap).forEach(item => {
                    const area = item.area || 'Sin área';
                    if (!areas[area]) {
                        areas[area] = [];
                    }
                    
                    // Formato ancho: una fila por evaluado
                    const row = [anonymize ? '***' : item.evaluado, item.area, anonymize ? '***' : item.manager];
                    item.pares.forEach(par => {
                        row.push(anonymize ? '***' : par);
                    });
                    
                    areas[area].push(row);
                });
                
                if (format === 'excel') {
                    const workbook = XLSX.utils.book_new();
                    
                    Object.keys(areas).forEach(area => {
                        const areaData = areas[area];
                        
                        // Calcular el máximo de pares en esta área para crear encabezados adecuados
                        let maxPares = 0;
                        areaData.forEach(row => {
                            if (row.length - 3 > maxPares) maxPares = row.length - 3;
                        });
                        
                        // Crear encabezados
                        const headers = ['Evaluado (identifier)', 'Área', 'Manager'];
                        for (let i = 1; i <= maxPares; i++) {
                            headers.push(`Par_${i}`);
                        }
                        
                        // Insertar encabezados al principio
                        areaData.unshift(headers);
                        
                        const worksheet = XLSX.utils.aoa_to_sheet(areaData);
                        const sheetName = area.length > 25 ? area.substring(0, 22) + '...' : area;
                        XLSX.utils.book_append_sheet(workbook, worksheet, sheetName);
                    });
                    
                    XLSX.writeFile(workbook, 'Relaciones_Pares_Segmentadas_360_Formato_Ancho.xlsx');
                } else {
                    downloadCombinedPairsWide(pairsMap, anonymize, format);
                }
            } else {
                downloadCombinedPairsWide(pairsMap, anonymize, format);
            }
        }
        
        // NUEVA FUNCIÓN: Descargar pares combinados en formato ancho
        function downloadCombinedPairsWide(pairsMap, anonymize, format) {
            // Convertir el mapa a array para procesar
            const pairsData = Object.values(pairsMap);
            
            // Encontrar el máximo número de pares que tiene alguien
            let maxPares = 0;
            pairsData.forEach(item => {
                if (item.pares.length > maxPares) maxPares = item.pares.length;
            });
            
            // Crear encabezados mejorados
            const headers = ['Evaluado (identifier)', 'Área', 'Manager'];
            for (let i = 1; i <= maxPares; i++) {
                headers.push(`Par_${i}`);
            }
            
            // Construir datos
            const data = [headers];
            
            pairsData.forEach(item => {
                const row = [
                    anonymize ? '***' : item.evaluado,
                    item.area,
                    anonymize ? '***' : item.manager
                ];
                
                // Añadir cada par a su columna correspondiente
                for (let i = 0; i < maxPares; i++) {
                    row.push(item.pares[i] ? (anonymize ? '***' : item.pares[i]) : '');
                }
                
                data.push(row);
            });
            
            // Para archivos muy grandes, mostrar advertencia
            if (data.length > 100000 && format === 'excel') {
                alert(`⚠️ ADVERTENCIA: El archivo tendrá ${data.length.toLocaleString()} filas. Esto puede tomar varios minutos.`);
            }
            
            if (format === 'excel') {
                const worksheet = XLSX.utils.aoa_to_sheet(data);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Pares (Formato Ancho)');
                
                // Añadir hoja con instrucciones
                const instructions = [
                    ['INSTRUCCIONES PARA EL ARCHIVO DE PARES 360°'],
                    [''],
                    ['Este archivo contiene las relaciones de pares para la evaluación 360°'],
                    ['Cada fila representa un evaluado y sus posibles evaluadores pares.'],
                    [''],
                    ['COLUMNAS:'],
                    ['1. Evaluado (identifier): Identificador único del empleado que será evaluado'],
                    ['2. Área: Área/departamento del evaluado'],
                    ['3. Manager: Manager del evaluado (excluido de la lista de pares)'],
                    ['4. Par_1 a Par_N: Identificadores de los compañeros que evaluarán al evaluado'],
                    [''],
                    ['CRITERIOS APLICADOS:'],
                    [`• Mismo Manager: SÍ (siempre)`],
                    [`• Excluir Manager: SÍ (siempre)`],
                    [`• Misma Área: NO (no se considera el área)`],
                    [`• Límite de pares: NO (todos los compañeros con el mismo manager)`],
                    [''],
                    ['NOTA: Los pares son todos los compañeros que comparten el mismo manager directo.'],
                    ['El manager NO aparece en la lista de pares (relación ascendente separada).']
                ];
                
                const instructionSheet = XLSX.utils.aoa_to_sheet(instructions);
                XLSX.utils.book_append_sheet(workbook, instructionSheet, 'Instrucciones');
                
                XLSX.writeFile(workbook, 'Relaciones_Pares_360_Formato_Ancho.xlsx');
            } else {
                const csvContent = data.map(row => 
                    row.map(cell => `"${cell}"`).join(',')
                ).join('\n');
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'Relaciones_Pares_360_Formato_Ancho.csv';
                link.click();
            }
        }
        
        // Descargar relaciones ascendentes
        function downloadAscendentes() {
            const format = document.querySelector('input[name="exportFormat"]:checked').value;
            const segment = segmentByDept.checked;
            const anonymize = anonymizeExport.checked;
            
            if (segment) {
                const areas = {};
                
                employees.forEach(emp => {
                    if (emp.manager_identifier && emp.manager_identifier !== emp.identifier) {
                        const area = emp.area_name || emp.area || 'Sin área';
                        if (!areas[area]) {
                            areas[area] = [];
                        }
                        
                        areas[area].push([
                            anonymize ? '***' : emp.identifier,
                            anonymize ? '***' : emp.manager_identifier,
                            'ascendente',
                            area,
                            'Evaluado evalúa a su jefe directo'
                        ]);
                    }
                });
                
                if (format === 'excel') {
                    const workbook = XLSX.utils.book_new();
                    
                    Object.keys(areas).forEach(area => {
                        const areaData = areas[area];
                        if (includeMetadata.checked) {
                            areaData.unshift(['evaluado_identifier', 'evaluador_identifier', 'tipo_relacion', 'area', 'descripcion']);
                        }
                        
                        const worksheet = XLSX.utils.aoa_to_sheet(areaData);
                        const sheetName = area.length > 25 ? area.substring(0, 22) + '...' : area;
                        XLSX.utils.book_append_sheet(workbook, worksheet, sheetName);
                    });
                    
                    XLSX.writeFile(workbook, 'Relaciones_Ascendentes_360.xlsx');
                } else {
                    downloadCombinedAscendentes(anonymize);
                }
            } else {
                downloadCombinedAscendentes(anonymize);
            }
        }
        
        // Descargar ascendentes combinados
        function downloadCombinedAscendentes(anonymize) {
            const format = document.querySelector('input[name="exportFormat"]:checked').value;
            
            const data = [
                ['evaluado_identifier', 'evaluador_identifier', 'tipo_relacion', 'descripcion']
            ];
            
            employees.forEach(emp => {
                if (emp.manager_identifier && emp.manager_identifier !== emp.identifier) {
                    data.push([
                        anonymize ? '***' : emp.identifier,
                        anonymize ? '***' : emp.manager_identifier,
                        'ascendente',
                        'El evaluado evalúa a su jefe directo (relación ascendente)'
                    ]);
                }
            });
            
            if (format === 'excel') {
                const worksheet = XLSX.utils.aoa_to_sheet(data);
                const workbook = XLSX.utils.book_new();
                
                // Añadir hoja de instrucciones
                const instructions = [
                    ['INSTRUCCIONES PARA EL ARCHIVO DE RELACIONES ASCENDENTES 360°'],
                    [''],
                    ['Este archivo contiene las relaciones ASCENDENTES para la evaluación 360°'],
                    ['Cada fila representa una relación donde un empleado evalúa a su jefe directo.'],
                    [''],
                    ['COLUMNAS:'],
                    ['1. evaluado_identifier: Identificador del empleado que realiza la evaluación'],
                    ['2. evaluador_identifier: Identificador del jefe que será evaluado'],
                    ['3. tipo_relacion: Siempre "ascendente"'],
                    ['4. descripcion: Descripción de la relación'],
                    [''],
                    ['NOTA: Esta es la relación donde los empleados evalúan a sus managers.'],
                    ['Cada empleado evalúa a su jefe directo (si tiene uno asignado).']
                ];
                
                const instructionSheet = XLSX.utils.aoa_to_sheet(instructions);
                XLSX.utils.book_append_sheet(workbook, instructionSheet, 'Instrucciones');
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Ascendentes');
                
                XLSX.writeFile(workbook, 'Relaciones_Ascendentes_360.xlsx');
            } else {
                const csvContent = data.map(row => 
                    row.map(cell => `"${cell}"`).join(',')
                ).join('\n');
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'Relaciones_Ascendentes_360.csv';
                link.click();
            }
        }
        
        // Descargar reporte ejecutivo - MEJORADO con duplicados
        function downloadReporte() {
            const workbook = XLSX.utils.book_new();
            
            const coveragePercentage = stats.coverageStats.fullyCovered > 0 ? 
                Math.round(stats.coverageStats.fullyCovered / stats.totalEmployees * 100) : 0;
            
            const summaryData = [
                ['REPORTE EJECUTIVO - ANÁLISIS DE POBLACIÓN 360°'],
                ['Fecha de generación', new Date().toLocaleString('es-ES')],
                ['Tiempo de procesamiento', `${processingTime.toFixed(3)} segundos`],
                ['Total empleados analizados', stats.totalEmployees],
                ['Configuración aplicada', config.useAdvancedConfig ? 'Personalizada' : 'Modo Simple (mismo manager, excluyendo jefes)'],
                [''],
                ['ESTADÍSTICAS PRINCIPALES', ''],
                ['Total de empleados', stats.totalEmployees],
                ['Empleados con manager asignado', stats.withManager],
                ['Porcentaje con manager', `${Math.round(stats.withManager / stats.totalEmployees * 100)}%`],
                ['Cobertura 360° completa según base', `${coveragePercentage}%`],
                ['Empleados con cobertura completa', stats.coverageStats.fullyCovered],
                ['Distribución por género (M/F)', `${stats.genderCount.M} / ${stats.genderCount.F}`],
                ['Áreas diferentes', Object.keys(stats.areaDistribution).length],
                ['Promedio de subordinados por manager', stats.avgSubordinates.toFixed(1)],
                ['Máximo de subordinados', stats.maxSubordinates],
                ['Mínimo de subordinados', stats.minSubordinates],
                ['Máximo evaluaciones por persona', stats.evaluationStats.maxEvaluations],
                ['Mínimo evaluaciones por persona', stats.evaluationStats.minEvaluations],
                ['Promedio evaluaciones por persona', stats.evaluationStats.avgEvaluations.toFixed(1)],
                ['Inconsistencias detectadas', stats.inconsistencias],
                ['Duplicados detectados', stats.duplicates],
                ['• Duplicados CRÍTICO (identifier)', stats.duplicatesByType?.CRÍTICO || 0],
                ['• Duplicados IMPORTANTE (rut, email)', stats.duplicatesByType?.IMPORTANTE || 0],
                [''],
                ['DISTRIBUCIÓN POR AÑOS EN LA EMPRESA', ''],
                ['Menos de 1 año', stats.tenureGroups['<1 año']],
                ['1-3 años', stats.tenureGroups['1-3 años']],
                ['3-5 años', stats.tenureGroups['3-5 años']],
                ['5-10 años', stats.tenureGroups['5-10 años']],
                ['Más de 10 años', stats.tenureGroups['10+ años']],
                [''],
                ['RECOMENDACIONES PARA EVALUACIÓN 360°', ''],
                ['1. Verificar y corregir las inconsistencias antes de proceder', ''],
                ['2. Resolver duplicados CRÍTICOS (identifier) antes de continuar', ''],
                ['3. Revisar duplicados IMPORTANTES (rut, email)', ''],
                ['4. Pares: Todos los compañeros con el mismo manager (excluyendo al manager)', ''],
                ['5. Balancear la carga de evaluación entre managers', ''],
                ['6. Validar que todos los managers existan en el sistema', ''],
                ['7. Revisar ciclos jerárquicos antes de la evaluación', '']
            ];
            
            const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(workbook, summarySheet, 'Resumen');
            
            const managersData = [
                ['TOP 10 MANAGERS CON MÁS SUBORDINADOS'],
                ['Posición', 'Identifier', 'Nombre', 'Área', 'Subordinados', 'Carga Evaluación', 'Estado']
            ];
            
            stats.topManagers.forEach((manager, index) => {
                const status = manager.evaluationLoad > config.maxCarga ? 'SOBRECARGADO' : 
                              manager.evaluationLoad > config.maxCarga * 0.7 ? 'ALERTA' : 'OK';
                
                managersData.push([
                    index + 1,
                    manager.identifier,
                    manager.name,
                    manager.area,
                    manager.subordinates,
                    manager.evaluationLoad,
                    status
                ]);
            });
            
            const managersSheet = XLSX.utils.aoa_to_sheet(managersData);
            XLSX.utils.book_append_sheet(workbook, managersSheet, 'Top Managers');
            
            // NUEVA HOJA: Duplicados Detectados
            if (duplicates.length > 0) {
                const duplicatesData = [
                    ['DUPLICADOS DETECTADOS'],
                    ['Tipo', 'Campo', 'Valor Duplicado', 'Registros Afectados', 'Áreas', 'Recomendación']
                ];
                
                duplicates.forEach(dup => {
                    let recomendacion = '';
                    if (dup.type === 'CRÍTICO') {
                        recomendacion = 'Resolver inmediatamente. Identifier debe ser único.';
                    } else if (dup.type === 'IMPORTANTE') {
                        if (dup.field === 'rut') {
                            recomendacion = 'Verificar si es la misma persona. RUT debe ser único.';
                        } else if (dup.field === 'email') {
                            recomendacion = 'Verificar emails. Cada empleado debe tener email único.';
                        }
                    }
                    
                    duplicatesData.push([
                        dup.type,
                        dup.field,
                        dup.key,
                        dup.affectedCount,
                        dup.areas.join(', '),
                        recomendacion
                    ]);
                });
                
                const duplicatesSheet = XLSX.utils.aoa_to_sheet(duplicatesData);
                XLSX.utils.book_append_sheet(workbook, duplicatesSheet, 'Duplicados');
            }
            
            const areaData = [
                ['DISTRIBUCIÓN DE EMPLEADOS POR ÁREA'],
                ['Área', 'Cantidad', 'Porcentaje', 'Con Manager', 'Cobertura 360°']
            ];
            
            const sortedAreas = Object.entries(stats.areaDistribution)
                .sort((a, b) => b[1] - a[1]);
            
            sortedAreas.forEach(([area, count]) => {
                const areaEmployees = employees.filter(emp => 
                    (emp.area_name || emp.area || 'Sin área') === area
                );
                
                const withManager = areaEmployees.filter(emp => 
                    emp.manager_identifier && emp.manager_identifier !== emp.identifier
                ).length;
                
                areaData.push([
                    area,
                    count,
                    `${(count / stats.totalEmployees * 100).toFixed(1)}%`,
                    withManager,
                    `${Math.round(withManager / count * 100)}%`
                ]);
            });
            
            const areaSheet = XLSX.utils.aoa_to_sheet(areaData);
            XLSX.utils.book_append_sheet(workbook, areaSheet, 'Áreas');
            
            XLSX.writeFile(workbook, 'Reporte_Ejecutivo_Analisis_360.xlsx');
        }
        
        // Volver al análisis
        function goBackToAnalysis() {
            downloadSection.style.display = 'none';
            updateProgress(3);
        }
        
        // Nuevo análisis
        function newAnalysis() {
            dashboard.style.display = 'none';
            uploadSection.style.display = 'block';
            resetApp();
            updateProgress(1);
        }
        
        // Reiniciar aplicación - CORREGIDO
        function resetApp() {
            fileInput.value = '';
            fileName.textContent = 'No se ha seleccionado ningún archivo';
            uploadBtn.disabled = true;
            loading.style.display = 'none';
            dashboard.style.display = 'none';
            configSection.style.display = 'none';
            uploadSection.style.display = 'block';
            downloadSection.style.display = 'none';
            
            originalData = [];
            employees = [];
            inconsistencies = [];
            duplicates = []; // NUEVO: Limpiar duplicados
            stats = {};
            processingTime = 0;
            
            config = {...defaultConfig};
            loadConfigToUI();
            
            if (genderChart) genderChart.destroy();
            if (areaChart) areaChart.destroy();
            if (subordinatesChart) subordinatesChart.destroy();
            if (tenureChart) tenureChart.destroy();
            
            stopLoadingTimer();
            resetAutoClearTimer();
            
            // Limpiar el tiempo de procesamiento mostrado
            finalProcessingTimeEl.textContent = '0.000';
            totalProcessedEmployeesEl.textContent = '0';
            
            // Ocultar estadísticas de evaluación
            evaluationStatsEl.style.display = 'none';
            
            // Actualizar UI
            inconsistenciesCount.textContent = '0';
            duplicatesCount.textContent = '0'; // NUEVO
            downloadInconsistenciesBtn.disabled = true;
            quickFixBtn.disabled = true;
            downloadAllDuplicatesBtn.disabled = true; // NUEVO
            
            // Limpiar tablas
            inconsistenciesBody.innerHTML = '';
            duplicatesBody.innerHTML = ''; // NUEVO
            managersBody.innerHTML = '';
            statsGrid.innerHTML = '';
            
            // Asegurarse de que el botón de upload esté deshabilitado
            uploadBtn.disabled = true;
            
            // Restablecer pestaña activa a Inconsistencias
            activateTab('inconsistencies');
        }
    </script>
</body>
</html>


